const a0_0x3f488a=a0_0x12bd;function a0_0x465e(){const _0x340ee0=['11940859NZFGUS','equal','set','catch','2528520wUxnUz','createDocument','$id','eligiblePoints','3lTVXFR','listSubmissions','name','readSubmission','251760JgtyKe','5ySfSVF','unique','submissions','submissionId','lineNumber','read','6945a9930023af1a7139','fileId','push','updateSubmissionGraded','17498106SZTzRD','reduce','deduction','1607194imLPqp','length','delete','listDocuments','updateDocument','update','fixes','user','726340RxQrMW','file','getUser','get','documents','2402874cufSGs','deleteDocument'];a0_0x465e=function(){return _0x340ee0;};return a0_0x465e();}(function(_0x36700d,_0x4006c5){const _0x24f7a4=a0_0x12bd,_0x36b518=_0x36700d();while(!![]){try{const _0x233fd6=-parseInt(_0x24f7a4(0x1ae))/0x1+parseInt(_0x24f7a4(0x1a6))/0x2+parseInt(_0x24f7a4(0x194))/0x3*(parseInt(_0x24f7a4(0x190))/0x4)+-parseInt(_0x24f7a4(0x199))/0x5*(-parseInt(_0x24f7a4(0x18a))/0x6)+parseInt(_0x24f7a4(0x18c))/0x7+parseInt(_0x24f7a4(0x198))/0x8+-parseInt(_0x24f7a4(0x1a3))/0x9;if(_0x233fd6===_0x4006c5)break;else _0x36b518['push'](_0x36b518['shift']());}catch(_0x29745f){_0x36b518['push'](_0x36b518['shift']());}}}(a0_0x465e,0xdc71b));import{auth}from'./auth.js';import{client,Databases,Storage,ID,Permission,Role,Query}from'./appwrite.js';const DATABASE_ID='6945a6580034b3c579df',SUBMISSIONS_COLLECTION_ID=a0_0x3f488a(0x19b),FIXES_COLLECTION_ID=a0_0x3f488a(0x1ac),STORAGE_BUCKET_ID=a0_0x3f488a(0x19f);function a0_0x12bd(_0x1db364,_0x305e82){const _0x465eaf=a0_0x465e();return a0_0x12bd=function(_0x12bd6d,_0x395aa6){_0x12bd6d=_0x12bd6d-0x186;let _0x301b2c=_0x465eaf[_0x12bd6d];return _0x301b2c;},a0_0x12bd(_0x1db364,_0x305e82);}class SubmissionService{#databases;#storage;constructor(_0x1064ce){this.#databases=new Databases(_0x1064ce),this.#storage=new Storage(_0x1064ce);}async['createSubmission'](_0x494242,_0x3060b2){const _0x20044d=a0_0x3f488a,_0x47e687=this.#submissionId(_0x494242);await this.#deleteSubmissionGroup(_0x47e687);const _0x1dab0f=await this.#uploadFiles(_0x3060b2),_0x212f7f=await this.#createFixes(_0x47e687,_0x3060b2,_0x1dab0f),_0x3b434e=this.#computeSummary(_0x212f7f),_0x1b3b7a=await this.#docPermissions();return await this.#databases[_0x20044d(0x191)](DATABASE_ID,SUBMISSIONS_COLLECTION_ID,_0x47e687,{..._0x494242,..._0x3b434e},_0x1b3b7a),_0x47e687;}async[a0_0x3f488a(0x197)](_0x5a015f){const _0x1f9faf=await this.#databases['getDocument'](DATABASE_ID,SUBMISSIONS_COLLECTION_ID,_0x5a015f),_0x5111ac=await this.#getFixes(_0x5a015f);return{'submission':_0x1f9faf,'fixes':_0x5111ac};}async['deleteSubmission'](_0x432aa5){await this.#deleteSubmissionGroup(_0x432aa5);}async[a0_0x3f488a(0x1a2)](_0x4d345d,_0x431daf){const _0x2acbb6=a0_0x3f488a;return this.#databases[_0x2acbb6(0x1aa)](DATABASE_ID,SUBMISSIONS_COLLECTION_ID,_0x4d345d,{'graded':_0x431daf});}async[a0_0x3f488a(0x195)](){const _0x52b3d2=a0_0x3f488a,_0x226135=await this.#databases[_0x52b3d2(0x1a9)](DATABASE_ID,SUBMISSIONS_COLLECTION_ID),_0x55580c=[];for(const _0x372604 of _0x226135[_0x52b3d2(0x189)]){const _0x109ef0=await this.#getFixes(_0x372604[_0x52b3d2(0x192)]);_0x55580c[_0x52b3d2(0x1a1)]({..._0x372604,'fixes':_0x109ef0[_0x52b3d2(0x189)]});}return _0x55580c;}#submissionId({studentID:_0x1b07ec,projectNumber:_0x23e1ef}){return _0x1b07ec+'-'+_0x23e1ef;}async #docPermissions(){const _0x3bf989=a0_0x3f488a;let _0x24e8e=[];const _0x39ae6e=await auth[_0x3bf989(0x187)]();if(_0x39ae6e){const _0x1e5595=_0x39ae6e['$id'];_0x24e8e=[Permission[_0x3bf989(0x19e)](Role[_0x3bf989(0x1ad)](_0x1e5595)),Permission[_0x3bf989(0x1ab)](Role[_0x3bf989(0x1ad)](_0x1e5595)),Permission[_0x3bf989(0x1a8)](Role['user'](_0x1e5595))];}return _0x24e8e;}async #uploadFiles(_0x56ff44){const _0x884451=a0_0x3f488a,_0x237187=new Map();for(const _0x451e7b of _0x56ff44){if(_0x237187['has'](_0x451e7b['file'][_0x884451(0x196)]))continue;const _0x31087e=await this.#docPermissions(),_0x1c1ee2=await this.#storage['createFile'](STORAGE_BUCKET_ID,ID['unique'](),_0x451e7b[_0x884451(0x186)],_0x31087e);_0x237187[_0x884451(0x18e)](_0x451e7b[_0x884451(0x186)][_0x884451(0x196)],_0x1c1ee2);}return _0x237187;}async #createFixes(_0x5cc582,_0x21a19f,_0x3603bc){const _0x33acd5=a0_0x3f488a,_0xb7c7ff=[];for(const _0x45c8fa of _0x21a19f){const _0x478d7f=_0x3603bc[_0x33acd5(0x188)](_0x45c8fa[_0x33acd5(0x186)][_0x33acd5(0x196)]),_0x4d2ccc=await this.#docPermissions(),_0x5ddc3d=await this.#databases[_0x33acd5(0x191)](DATABASE_ID,FIXES_COLLECTION_ID,ID[_0x33acd5(0x19a)](),{'submissionId':_0x5cc582,'fileName':_0x478d7f[_0x33acd5(0x196)],'fileId':_0x478d7f[_0x33acd5(0x192)],'lineNumber':_0x45c8fa[_0x33acd5(0x19d)],'deduction':_0x45c8fa[_0x33acd5(0x1a5)],'eligiblePoints':_0x45c8fa[_0x33acd5(0x193)]},_0x4d2ccc);_0xb7c7ff[_0x33acd5(0x1a1)](_0x5ddc3d);}return _0xb7c7ff;}async #getFixes(_0x34d339){const _0x17ca47=a0_0x3f488a;return this.#databases[_0x17ca47(0x1a9)](DATABASE_ID,FIXES_COLLECTION_ID,[Query[_0x17ca47(0x18d)](_0x17ca47(0x19c),_0x34d339)]);}async #deleteSubmissionGroup(_0x4d26b1){const _0x9e9972=a0_0x3f488a,_0x2d0627=await this.#getFixes(_0x4d26b1);for(const _0x1467b6 of _0x2d0627[_0x9e9972(0x189)]){await this.#storage['deleteFile'](STORAGE_BUCKET_ID,_0x1467b6[_0x9e9972(0x1a0)])[_0x9e9972(0x18f)](()=>{});}for(const _0x274e8b of _0x2d0627[_0x9e9972(0x189)]){await this.#databases['deleteDocument'](DATABASE_ID,FIXES_COLLECTION_ID,_0x274e8b[_0x9e9972(0x192)])[_0x9e9972(0x18f)](()=>{});}await this.#databases[_0x9e9972(0x18b)](DATABASE_ID,SUBMISSIONS_COLLECTION_ID,_0x4d26b1)['catch'](()=>{});}#computeSummary(_0x4d3ac6){const _0xe8ae77=a0_0x3f488a;return{'fixCount':_0x4d3ac6[_0xe8ae77(0x1a7)],'totalEligible':_0x4d3ac6[_0xe8ae77(0x1a4)]((_0x35b11d,_0xaaecea)=>_0x35b11d+_0xaaecea['eligiblePoints'],0x0),'totalDeductions':_0x4d3ac6[_0xe8ae77(0x1a4)]((_0x4b11e6,_0x3cb61b)=>_0x4b11e6+_0x3cb61b['deduction'],0x0)};}}export const db=new SubmissionService(client);