function a0_0x3993(){const _0x1e6d82=['readSubmission','listDocuments','deleteFile','documents','has','eligiblePoints','6945a9930023af1a7139','update','delete','createSubmission','210pzsBEV','listSubmissions','user','submissionId','read','8cqoNXq','14HnccYa','catch','lineNumber','2023832RntAyA','971778YeYdRI','1671084NeVEOy','file','submissions','updateSubmissionGraded','getUser','deleteSubmission','getDocument','name','913253AusQZN','deduction','fileId','2697699mceNPg','unique','4ezHdWL','1253980CLhcFR','reduce','createFile','4315045UDpJyB','updateDocument','push','createDocument','$id'];a0_0x3993=function(){return _0x1e6d82;};return a0_0x3993();}const a0_0x1a7bd8=a0_0x2b32;(function(_0x587855,_0xbb5e03){const _0x234d79=a0_0x2b32,_0x551bcf=_0x587855();while(!![]){try{const _0x565e55=parseInt(_0x234d79(0x1ea))/0x1+-parseInt(_0x234d79(0x1da))/0x2+parseInt(_0x234d79(0x1e7))/0x3*(-parseInt(_0x234d79(0x1e9))/0x4)+-parseInt(_0x234d79(0x1ed))/0x5+-parseInt(_0x234d79(0x1db))/0x6*(-parseInt(_0x234d79(0x1d7))/0x7)+parseInt(_0x234d79(0x1d6))/0x8*(parseInt(_0x234d79(0x1dc))/0x9)+-parseInt(_0x234d79(0x1d1))/0xa*(-parseInt(_0x234d79(0x1e4))/0xb);if(_0x565e55===_0xbb5e03)break;else _0x551bcf['push'](_0x551bcf['shift']());}catch(_0x4b5dd8){_0x551bcf['push'](_0x551bcf['shift']());}}}(a0_0x3993,0xb2eeb));function a0_0x2b32(_0x36134b,_0x11e717){const _0x399300=a0_0x3993();return a0_0x2b32=function(_0x2b3212,_0x56063a){_0x2b3212=_0x2b3212-0x1cb;let _0x5e9268=_0x399300[_0x2b3212];return _0x5e9268;},a0_0x2b32(_0x36134b,_0x11e717);}import{auth}from'./auth.js';import{client,Databases,Storage,ID,Permission,Role,Query}from'./appwrite.js';const DATABASE_ID='6945a6580034b3c579df',SUBMISSIONS_COLLECTION_ID=a0_0x1a7bd8(0x1de),FIXES_COLLECTION_ID='fixes',STORAGE_BUCKET_ID=a0_0x1a7bd8(0x1cd);class SubmissionService{#databases;#storage;constructor(_0x5bb597){this.#databases=new Databases(_0x5bb597),this.#storage=new Storage(_0x5bb597);}async[a0_0x1a7bd8(0x1d0)](_0x2171e8,_0x2ad327){const _0x181f28=a0_0x1a7bd8,_0x4e438c=this.#submissionId(_0x2171e8);await this.#deleteSubmissionGroup(_0x4e438c);const _0x2e161c=await this.#uploadFiles(_0x2ad327),_0x3444d1=await this.#createFixes(_0x4e438c,_0x2ad327,_0x2e161c),_0xa34b7c=this.#computeSummary(_0x3444d1),_0x4bb963=await this.#docPermissions();return await this.#databases[_0x181f28(0x1f0)](DATABASE_ID,SUBMISSIONS_COLLECTION_ID,_0x4e438c,{..._0x2171e8,..._0xa34b7c},_0x4bb963),_0x4e438c;}async[a0_0x1a7bd8(0x1f2)](_0x3a10a4){const _0x1317ca=a0_0x1a7bd8,_0x123eda=await this.#databases[_0x1317ca(0x1e2)](DATABASE_ID,SUBMISSIONS_COLLECTION_ID,_0x3a10a4),_0x3b282c=await this.#getFixes(_0x3a10a4);return{'submission':_0x123eda,'fixes':_0x3b282c};}async[a0_0x1a7bd8(0x1e1)](_0x52188d){await this.#deleteSubmissionGroup(_0x52188d);}async[a0_0x1a7bd8(0x1df)](_0x250966,_0x1f46b6){const _0x3631c0=a0_0x1a7bd8;return this.#databases[_0x3631c0(0x1ee)](DATABASE_ID,SUBMISSIONS_COLLECTION_ID,_0x250966,{'graded':_0x1f46b6});}async[a0_0x1a7bd8(0x1d2)](){const _0xc59143=a0_0x1a7bd8,_0x16956a=await this.#databases[_0xc59143(0x1f3)](DATABASE_ID,SUBMISSIONS_COLLECTION_ID),_0x3d04ed=[];for(const _0x40d8fb of _0x16956a[_0xc59143(0x1f5)]){const _0x6b8110=await this.#getFixes(_0x40d8fb[_0xc59143(0x1f1)]);_0x3d04ed[_0xc59143(0x1ef)]({..._0x40d8fb,'fixes':_0x6b8110[_0xc59143(0x1f5)]});}return _0x3d04ed;}#submissionId({studentID:_0x4acbb7,projectNumber:_0x4c5e35}){return _0x4acbb7+'-'+_0x4c5e35;}async #docPermissions(){const _0x2bceb2=a0_0x1a7bd8;let _0x4c16d6=[];const _0x29fd6c=await auth[_0x2bceb2(0x1e0)]();if(_0x29fd6c){const _0x1f233b=_0x29fd6c[_0x2bceb2(0x1f1)];_0x4c16d6=[Permission[_0x2bceb2(0x1d5)](Role[_0x2bceb2(0x1d3)](_0x1f233b)),Permission[_0x2bceb2(0x1ce)](Role[_0x2bceb2(0x1d3)](_0x1f233b)),Permission[_0x2bceb2(0x1cf)](Role['user'](_0x1f233b))];}return _0x4c16d6;}async #uploadFiles(_0x19da3f){const _0xc270f3=a0_0x1a7bd8,_0x4abb9c=new Map();for(const _0x32b247 of _0x19da3f){if(_0x4abb9c[_0xc270f3(0x1cb)](_0x32b247[_0xc270f3(0x1dd)][_0xc270f3(0x1e3)]))continue;const _0x5a7695=await this.#docPermissions(),_0xa98e19=await this.#storage[_0xc270f3(0x1ec)](STORAGE_BUCKET_ID,ID[_0xc270f3(0x1e8)](),_0x32b247[_0xc270f3(0x1dd)],_0x5a7695);_0x4abb9c['set'](_0x32b247['file'][_0xc270f3(0x1e3)],_0xa98e19);}return _0x4abb9c;}async #createFixes(_0x7f158a,_0x58bd61,_0x5901d1){const _0x3bf7de=a0_0x1a7bd8,_0x19696a=[];for(const _0x469f3e of _0x58bd61){const _0x4508e9=_0x5901d1['get'](_0x469f3e[_0x3bf7de(0x1dd)][_0x3bf7de(0x1e3)]),_0x524cb7=await this.#docPermissions(),_0x47cf72=await this.#databases[_0x3bf7de(0x1f0)](DATABASE_ID,FIXES_COLLECTION_ID,ID['unique'](),{'submissionId':_0x7f158a,'fileName':_0x4508e9[_0x3bf7de(0x1e3)],'fileId':_0x4508e9[_0x3bf7de(0x1f1)],'lineNumber':_0x469f3e[_0x3bf7de(0x1d9)],'deduction':_0x469f3e[_0x3bf7de(0x1e5)],'eligiblePoints':_0x469f3e[_0x3bf7de(0x1cc)]},_0x524cb7);_0x19696a['push'](_0x47cf72);}return _0x19696a;}async #getFixes(_0x17b873){const _0x764d4=a0_0x1a7bd8;return this.#databases[_0x764d4(0x1f3)](DATABASE_ID,FIXES_COLLECTION_ID,[Query['equal'](_0x764d4(0x1d4),_0x17b873)]);}async #deleteSubmissionGroup(_0x1690fd){const _0x8daccd=a0_0x1a7bd8,_0x1409fb=await this.#getFixes(_0x1690fd);for(const _0x1b6ef7 of _0x1409fb['documents']){await this.#storage[_0x8daccd(0x1f4)](STORAGE_BUCKET_ID,_0x1b6ef7[_0x8daccd(0x1e6)])[_0x8daccd(0x1d8)](()=>{});}for(const _0x565c13 of _0x1409fb[_0x8daccd(0x1f5)]){await this.#databases['deleteDocument'](DATABASE_ID,FIXES_COLLECTION_ID,_0x565c13[_0x8daccd(0x1f1)])[_0x8daccd(0x1d8)](()=>{});}await this.#databases['deleteDocument'](DATABASE_ID,SUBMISSIONS_COLLECTION_ID,_0x1690fd)['catch'](()=>{});}#computeSummary(_0x5a4847){const _0x507605=a0_0x1a7bd8;return{'fixCount':_0x5a4847['length'],'totalEligible':_0x5a4847[_0x507605(0x1eb)]((_0x4ad333,_0x2c0e38)=>_0x4ad333+_0x2c0e38[_0x507605(0x1cc)],0x0),'totalDeductions':_0x5a4847[_0x507605(0x1eb)]((_0x206e23,_0x2afd42)=>_0x206e23+_0x2afd42['deduction'],0x0)};}}export const db=new SubmissionService(client);