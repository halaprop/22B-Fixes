const a0_0x11e84b=a0_0x5ede;(function(_0x44461d,_0x44256c){const _0x1ef8f5=a0_0x5ede,_0x46663d=_0x44461d();while(!![]){try{const _0x4c6ddb=parseInt(_0x1ef8f5(0xbe))/0x1*(-parseInt(_0x1ef8f5(0xb8))/0x2)+-parseInt(_0x1ef8f5(0xc5))/0x3*(-parseInt(_0x1ef8f5(0xda))/0x4)+-parseInt(_0x1ef8f5(0xc2))/0x5*(-parseInt(_0x1ef8f5(0xde))/0x6)+-parseInt(_0x1ef8f5(0xc1))/0x7+-parseInt(_0x1ef8f5(0xcb))/0x8*(parseInt(_0x1ef8f5(0xd1))/0x9)+parseInt(_0x1ef8f5(0xbf))/0xa+-parseInt(_0x1ef8f5(0xc6))/0xb;if(_0x4c6ddb===_0x44256c)break;else _0x46663d['push'](_0x46663d['shift']());}catch(_0x3c4fdd){_0x46663d['push'](_0x46663d['shift']());}}}(a0_0x3cdc,0x241b9));import{auth}from'./auth.js';import{client,Databases,Storage,ID,Permission,Role,Query}from'./appwrite.js';const DATABASE_ID=a0_0x11e84b(0xcc),SUBMISSIONS_COLLECTION_ID=a0_0x11e84b(0xd5),FIXES_COLLECTION_ID=a0_0x11e84b(0xcf),ZYBOOK_STUDENTS_COLLECTION_ID=a0_0x11e84b(0xdc),STORAGE_BUCKET_ID=a0_0x11e84b(0xbd);function a0_0x3cdc(){const _0xc1671a=['unique','$id','catch','88isuMii','6945a6580034b3c579df','has','getDocument','fixes','submissionId','50211DesDGL','file','update','listDocuments','submissions','eligiblePoints','user','set','delete','8WtDENw','documents','zybookStudents','get','1501122kDdgIh','createDocument','canvasId','deleteDocument','lineNumber','55058WbHCIM','getUser','deleteFile','name','updateSubmissionGraded','6945a9930023af1a7139','5QxCHER','2200140HtaFUW','readSubmission','2052036ojcUbx','5QLtWWx','listSubmissions','fileId','289983ouMtte','258104HTNCCK','equal'];a0_0x3cdc=function(){return _0xc1671a;};return a0_0x3cdc();}class SubmissionService{#databases;#storage;constructor(_0x59f3b2){this.#databases=new Databases(_0x59f3b2),this.#storage=new Storage(_0x59f3b2);}async['createSubmission'](_0x13ec96,_0x339869){const _0x30bfd5=a0_0x11e84b,_0x41e956=this.#submissionId(_0x13ec96);await this.#deleteSubmissionGroup(_0x41e956);const _0x8cd22a=await this.#uploadFiles(_0x339869),_0x4e71a1=await this.#createFixes(_0x41e956,_0x339869,_0x8cd22a),_0xc56f0a=this.#computeSummary(_0x4e71a1),_0x49126b=await this.#docPermissions();return await this.#databases[_0x30bfd5(0xdf)](DATABASE_ID,SUBMISSIONS_COLLECTION_ID,_0x41e956,{..._0x13ec96,..._0xc56f0a},_0x49126b),_0x41e956;}async[a0_0x11e84b(0xc0)](_0x5a5135){const _0x2394a2=a0_0x11e84b,_0x34d369=await this.#databases[_0x2394a2(0xce)](DATABASE_ID,SUBMISSIONS_COLLECTION_ID,_0x5a5135),_0x360696=await this.#getFixes(_0x5a5135);return{'submission':_0x34d369,'fixes':_0x360696};}async['deleteSubmission'](_0x489268){await this.#deleteSubmissionGroup(_0x489268);}async[a0_0x11e84b(0xbc)](_0x19cbe4,_0x28bac3){return this.#databases['updateDocument'](DATABASE_ID,SUBMISSIONS_COLLECTION_ID,_0x19cbe4,{'graded':_0x28bac3});}async[a0_0x11e84b(0xc3)](){const _0xc6f31b=a0_0x11e84b,_0x3a46e3=await this.#databases['listDocuments'](DATABASE_ID,SUBMISSIONS_COLLECTION_ID),_0x36118a=[];for(const _0x2b09f2 of _0x3a46e3[_0xc6f31b(0xdb)]){const _0x32f1bc=await this.#getFixes(_0x2b09f2[_0xc6f31b(0xc9)]);_0x36118a['push']({..._0x2b09f2,'fixes':_0x32f1bc[_0xc6f31b(0xdb)]});}return _0x36118a;}async['zybookStudent'](_0x2f77b6){const _0x3f6449=a0_0x11e84b,_0x159aab=await this.#databases['listDocuments'](DATABASE_ID,ZYBOOK_STUDENTS_COLLECTION_ID,[Query[_0x3f6449(0xc7)](_0x3f6449(0xe0),_0x2f77b6)]);return _0x159aab[_0x3f6449(0xdb)][0x0]??null;}#submissionId({studentID:_0x1fca77,projectNumber:_0x24a9c8}){return _0x1fca77+'-'+_0x24a9c8;}async #docPermissions(){const _0x260d7d=a0_0x11e84b;let _0xfb2d4e=[];const _0x2ff405=await auth[_0x260d7d(0xb9)]();if(_0x2ff405){const _0x514fdb=_0x2ff405['$id'];_0xfb2d4e=[Permission['read'](Role[_0x260d7d(0xd7)](_0x514fdb)),Permission[_0x260d7d(0xd3)](Role['user'](_0x514fdb)),Permission[_0x260d7d(0xd9)](Role[_0x260d7d(0xd7)](_0x514fdb))];}return _0xfb2d4e;}async #uploadFiles(_0xd24c11){const _0x111ec7=a0_0x11e84b,_0x35f3e2=new Map();for(const _0x53979c of _0xd24c11){if(_0x35f3e2[_0x111ec7(0xcd)](_0x53979c[_0x111ec7(0xd2)][_0x111ec7(0xbb)]))continue;const _0x4d851c=await this.#docPermissions(),_0x400a50=await this.#storage['createFile'](STORAGE_BUCKET_ID,ID[_0x111ec7(0xc8)](),_0x53979c[_0x111ec7(0xd2)],_0x4d851c);_0x35f3e2[_0x111ec7(0xd8)](_0x53979c[_0x111ec7(0xd2)][_0x111ec7(0xbb)],_0x400a50);}return _0x35f3e2;}async #createFixes(_0x307cdf,_0x24e604,_0x499e55){const _0x18560b=a0_0x11e84b,_0xc7c16a=[];for(const _0x21a487 of _0x24e604){const _0x276953=_0x499e55[_0x18560b(0xdd)](_0x21a487[_0x18560b(0xd2)][_0x18560b(0xbb)]),_0x162730=await this.#docPermissions(),_0x32793e=await this.#databases[_0x18560b(0xdf)](DATABASE_ID,FIXES_COLLECTION_ID,ID[_0x18560b(0xc8)](),{'submissionId':_0x307cdf,'fileName':_0x276953[_0x18560b(0xbb)],'fileId':_0x276953[_0x18560b(0xc9)],'lineNumber':_0x21a487[_0x18560b(0xe2)],'deduction':_0x21a487['deduction'],'eligiblePoints':_0x21a487[_0x18560b(0xd6)]},_0x162730);_0xc7c16a['push'](_0x32793e);}return _0xc7c16a;}async #getFixes(_0x19e663){const _0x9606bb=a0_0x11e84b;return this.#databases[_0x9606bb(0xd4)](DATABASE_ID,FIXES_COLLECTION_ID,[Query[_0x9606bb(0xc7)](_0x9606bb(0xd0),_0x19e663)]);}async #deleteSubmissionGroup(_0x51233f){const _0x550053=a0_0x11e84b,_0x17da95=await this.#getFixes(_0x51233f);for(const _0x3969ce of _0x17da95[_0x550053(0xdb)]){await this.#storage[_0x550053(0xba)](STORAGE_BUCKET_ID,_0x3969ce[_0x550053(0xc4)])[_0x550053(0xca)](()=>{});}for(const _0x127d7c of _0x17da95[_0x550053(0xdb)]){await this.#databases[_0x550053(0xe1)](DATABASE_ID,FIXES_COLLECTION_ID,_0x127d7c[_0x550053(0xc9)])[_0x550053(0xca)](()=>{});}await this.#databases[_0x550053(0xe1)](DATABASE_ID,SUBMISSIONS_COLLECTION_ID,_0x51233f)[_0x550053(0xca)](()=>{});}#computeSummary(_0x48d207){const _0x5a7904=a0_0x11e84b;return{'fixCount':_0x48d207['length'],'totalEligible':_0x48d207['reduce']((_0x22fd3b,_0x5ed812)=>_0x22fd3b+_0x5ed812[_0x5a7904(0xd6)],0x0),'totalDeductions':_0x48d207['reduce']((_0x236056,_0x1d637e)=>_0x236056+_0x1d637e['deduction'],0x0)};}}function a0_0x5ede(_0x545fe3,_0x3b95ea){const _0x3cdc5d=a0_0x3cdc();return a0_0x5ede=function(_0x5ededd,_0x2d5740){_0x5ededd=_0x5ededd-0xb8;let _0x1e1b91=_0x3cdc5d[_0x5ededd];return _0x1e1b91;},a0_0x5ede(_0x545fe3,_0x3b95ea);}export const db=new SubmissionService(client);