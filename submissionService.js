const a0_0x279a22=a0_0xd372;function a0_0x3a03(){const _0x2e6b36=['978392ImMYFE','2566956blLWnB','7WYoGbn','push','4443530wWhAch','deleteDocument','submissions','2418215UFDBFt','getDocument','listSubmissions','read','unique','length','deduction','reduce','user','file','$id','309018ytgAPl','documents','77shXRlD','34112ktEMzs','deleteFile','update','6945a9930023af1a7139','readSubmission','18vsayQB','1504668mHpPGl','deleteSubmission','equal','eligiblePoints','name','18fffAPW','createDocument','6945a6580034b3c579df','get','set','catch','123GMqPvW','has','lineNumber','createFile','updateDocument','listDocuments','createSubmission'];a0_0x3a03=function(){return _0x2e6b36;};return a0_0x3a03();}(function(_0x93093d,_0x1c6e35){const _0x5e2108=a0_0xd372,_0x1d74df=_0x93093d();while(!![]){try{const _0x296a70=parseInt(_0x5e2108(0xea))/0x1*(-parseInt(_0x5e2108(0xfa))/0x2)+parseInt(_0x5e2108(0xe1))/0x3*(parseInt(_0x5e2108(0xfd))/0x4)+-parseInt(_0x5e2108(0xef))/0x5+parseInt(_0x5e2108(0x102))/0x6*(parseInt(_0x5e2108(0xe9))/0x7)+-parseInt(_0x5e2108(0xe8))/0x8*(-parseInt(_0x5e2108(0xdb))/0x9)+-parseInt(_0x5e2108(0xec))/0xa+-parseInt(_0x5e2108(0xfc))/0xb*(-parseInt(_0x5e2108(0x103))/0xc);if(_0x296a70===_0x1c6e35)break;else _0x1d74df['push'](_0x1d74df['shift']());}catch(_0x42873f){_0x1d74df['push'](_0x1d74df['shift']());}}}(a0_0x3a03,0x89566));import{auth}from'./auth.js';import{client,Databases,Storage,ID,Permission,Role,Query}from'./appwrite.js';const DATABASE_ID=a0_0x279a22(0xdd),SUBMISSIONS_COLLECTION_ID=a0_0x279a22(0xee),FIXES_COLLECTION_ID='fixes',STORAGE_BUCKET_ID=a0_0x279a22(0x100);function a0_0xd372(_0x366b70,_0x3668dc){const _0x3a0393=a0_0x3a03();return a0_0xd372=function(_0xd37240,_0x45a791){_0xd37240=_0xd37240-0xda;let _0x1ec95e=_0x3a0393[_0xd37240];return _0x1ec95e;},a0_0xd372(_0x366b70,_0x3668dc);}class SubmissionService{#databases;#storage;constructor(_0x577015){this.#databases=new Databases(_0x577015),this.#storage=new Storage(_0x577015);}async[a0_0x279a22(0xe7)](_0x38e1ff,_0x186c4d){const _0x4831c2=a0_0x279a22,_0xbf5b15=this.#submissionId(_0x38e1ff);await this.#deleteSubmissionGroup(_0xbf5b15);const _0x48e919=await this.#uploadFiles(_0x186c4d),_0x3cc3a3=await this.#createFixes(_0xbf5b15,_0x186c4d,_0x48e919),_0x966938=this.#computeSummary(_0x3cc3a3),_0x38438a=await this.#docPermissions();return await this.#databases[_0x4831c2(0xdc)](DATABASE_ID,SUBMISSIONS_COLLECTION_ID,_0xbf5b15,{..._0x38e1ff,..._0x966938},_0x38438a),_0xbf5b15;}async[a0_0x279a22(0x101)](_0x4e6d25){const _0x185f6c=a0_0x279a22,_0x24573d=await this.#databases[_0x185f6c(0xf0)](DATABASE_ID,SUBMISSIONS_COLLECTION_ID,_0x4e6d25),_0x3ba797=await this.#getFixes(_0x4e6d25);return{'submission':_0x24573d,'fixes':_0x3ba797};}async[a0_0x279a22(0x104)](_0x22358f){await this.#deleteSubmissionGroup(_0x22358f);}async['updateSubmissionGraded'](_0xb875fd,_0x4f1397){const _0x1c9ab7=a0_0x279a22;return this.#databases[_0x1c9ab7(0xe5)](DATABASE_ID,SUBMISSIONS_COLLECTION_ID,_0xb875fd,{'graded':_0x4f1397});}async[a0_0x279a22(0xf1)](){const _0x5b9041=a0_0x279a22,_0x452b9c=await this.#databases[_0x5b9041(0xe6)](DATABASE_ID,SUBMISSIONS_COLLECTION_ID),_0xc27b98=[];for(const _0x11f88e of _0x452b9c['documents']){const _0x328826=await this.#getFixes(_0x11f88e[_0x5b9041(0xf9)]);_0xc27b98[_0x5b9041(0xeb)]({..._0x11f88e,'fixes':_0x328826[_0x5b9041(0xfb)]});}return _0xc27b98;}#submissionId({studentID:_0x367b1a,projectNumber:_0x37c9a4}){return _0x367b1a+'-'+_0x37c9a4;}async #docPermissions(){const _0x108153=a0_0x279a22;let _0x44934e=[];const _0x11a9b5=await auth['getUser']();if(_0x11a9b5){const _0x30321b=_0x11a9b5[_0x108153(0xf9)];_0x44934e=[Permission[_0x108153(0xf2)](Role[_0x108153(0xf7)](_0x30321b)),Permission[_0x108153(0xff)](Role[_0x108153(0xf7)](_0x30321b)),Permission['delete'](Role[_0x108153(0xf7)](_0x30321b))];}return _0x44934e;}async #uploadFiles(_0x42e241){const _0x141c5d=a0_0x279a22,_0x5c1e38=new Map();for(const _0x11397d of _0x42e241){if(_0x5c1e38[_0x141c5d(0xe2)](_0x11397d[_0x141c5d(0xf8)][_0x141c5d(0xda)]))continue;const _0x268bcb=await this.#docPermissions(),_0x5f29bc=await this.#storage[_0x141c5d(0xe4)](STORAGE_BUCKET_ID,ID[_0x141c5d(0xf3)](),_0x11397d[_0x141c5d(0xf8)],_0x268bcb);_0x5c1e38[_0x141c5d(0xdf)](_0x11397d['file'][_0x141c5d(0xda)],_0x5f29bc);}return _0x5c1e38;}async #createFixes(_0x2c232e,_0x4f36d2,_0x403e3c){const _0x5dd725=a0_0x279a22,_0x58da66=[];for(const _0x3c4ea2 of _0x4f36d2){const _0x529fdd=_0x403e3c[_0x5dd725(0xde)](_0x3c4ea2[_0x5dd725(0xf8)][_0x5dd725(0xda)]),_0x149b8b=await this.#docPermissions(),_0x4f92ca=await this.#databases[_0x5dd725(0xdc)](DATABASE_ID,FIXES_COLLECTION_ID,ID['unique'](),{'submissionId':_0x2c232e,'fileName':_0x529fdd['name'],'fileId':_0x529fdd['$id'],'lineNumber':_0x3c4ea2[_0x5dd725(0xe3)],'deduction':_0x3c4ea2[_0x5dd725(0xf5)],'eligiblePoints':_0x3c4ea2['eligiblePoints']},_0x149b8b);_0x58da66[_0x5dd725(0xeb)](_0x4f92ca);}return _0x58da66;}async #getFixes(_0x1df381){const _0x365f8a=a0_0x279a22;return this.#databases['listDocuments'](DATABASE_ID,FIXES_COLLECTION_ID,[Query[_0x365f8a(0x105)]('submissionId',_0x1df381)]);}async #deleteSubmissionGroup(_0x59f9ef){const _0x472aba=a0_0x279a22,_0xb55709=await this.#getFixes(_0x59f9ef);for(const _0x10b725 of _0xb55709['documents']){await this.#storage[_0x472aba(0xfe)](STORAGE_BUCKET_ID,_0x10b725['fileId'])[_0x472aba(0xe0)](()=>{});}for(const _0x4af0d5 of _0xb55709['documents']){await this.#databases[_0x472aba(0xed)](DATABASE_ID,FIXES_COLLECTION_ID,_0x4af0d5[_0x472aba(0xf9)])[_0x472aba(0xe0)](()=>{});}await this.#databases[_0x472aba(0xed)](DATABASE_ID,SUBMISSIONS_COLLECTION_ID,_0x59f9ef)['catch'](()=>{});}#computeSummary(_0x188307){const _0x3f5afd=a0_0x279a22;return{'fixCount':_0x188307[_0x3f5afd(0xf4)],'totalEligible':_0x188307[_0x3f5afd(0xf6)]((_0x4853d6,_0x53e237)=>_0x4853d6+_0x53e237[_0x3f5afd(0x106)],0x0),'totalDeductions':_0x188307['reduce']((_0x5bab79,_0x1d87b3)=>_0x5bab79+_0x1d87b3[_0x3f5afd(0xf5)],0x0)};}}export const db=new SubmissionService(client);