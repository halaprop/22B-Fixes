const a0_0x2a2632=a0_0x1d1e;(function(_0x32937e,_0xf5a290){const _0x5297b5=a0_0x1d1e,_0x2d217d=_0x32937e();while(!![]){try{const _0x9c2471=parseInt(_0x5297b5(0x106))/0x1*(-parseInt(_0x5297b5(0xef))/0x2)+-parseInt(_0x5297b5(0xf3))/0x3+parseInt(_0x5297b5(0x101))/0x4+-parseInt(_0x5297b5(0xf1))/0x5*(-parseInt(_0x5297b5(0x10e))/0x6)+-parseInt(_0x5297b5(0x108))/0x7+-parseInt(_0x5297b5(0xfe))/0x8+-parseInt(_0x5297b5(0x118))/0x9*(-parseInt(_0x5297b5(0xee))/0xa);if(_0x9c2471===_0xf5a290)break;else _0x2d217d['push'](_0x2d217d['shift']());}catch(_0x3a49b3){_0x2d217d['push'](_0x2d217d['shift']());}}}(a0_0xa009,0xb97e3));function a0_0xa009(){const _0x4a1c88=['deleteFile','deduction','name','submissionId','file','6945a9930023af1a7139','get','deleteSubmission','36NRIzUp','has','length','7707860jEwDKn','10AfiLer','createSubmission','15FxdMLp','fileId','4118382sZZJHv','getUser','eligiblePoints','updateDocument','getDocument','fixes','catch','reduce','push','update','lineNumber','746424CqYxkH','set','createDocument','195404RNfMci','unique','documents','equal','deleteDocument','255333eGAQyE','user','3550337ruTRuy','listSubmissions','listDocuments','readSubmission','6945a6580034b3c579df','updateSubmissionGraded','1755474LHUhZw','$id'];a0_0xa009=function(){return _0x4a1c88;};return a0_0xa009();}import{auth}from'./auth.js';function a0_0x1d1e(_0x222f58,_0x2b5de2){const _0xa00985=a0_0xa009();return a0_0x1d1e=function(_0x1d1e83,_0x248a1c){_0x1d1e83=_0x1d1e83-0xed;let _0xc940da=_0xa00985[_0x1d1e83];return _0xc940da;},a0_0x1d1e(_0x222f58,_0x2b5de2);}import{client,Databases,Storage,ID,Permission,Role,Query}from'./appwrite.js';const DATABASE_ID=a0_0x2a2632(0x10c),SUBMISSIONS_COLLECTION_ID='submissions',FIXES_COLLECTION_ID=a0_0x2a2632(0xf8),STORAGE_BUCKET_ID=a0_0x2a2632(0x115);class SubmissionService{#databases;#storage;constructor(_0x1667f2){this.#databases=new Databases(_0x1667f2),this.#storage=new Storage(_0x1667f2);}async[a0_0x2a2632(0xf0)](_0x1dd885,_0x1a7a3d){const _0x303e34=this.#submissionId(_0x1dd885);await this.#deleteSubmissionGroup(_0x303e34);const _0x3793f9=await this.#uploadFiles(_0x1a7a3d),_0x519d7a=await this.#createFixes(_0x303e34,_0x1a7a3d,_0x3793f9),_0x5a6bdf=this.#computeSummary(_0x519d7a),_0x502ca0=await this.#docPermissions();return await this.#databases['createDocument'](DATABASE_ID,SUBMISSIONS_COLLECTION_ID,_0x303e34,{..._0x1dd885,..._0x5a6bdf},_0x502ca0),_0x303e34;}async[a0_0x2a2632(0x10b)](_0x57f39f){const _0xd724c9=a0_0x2a2632,_0x4a09ff=await this.#databases[_0xd724c9(0xf7)](DATABASE_ID,SUBMISSIONS_COLLECTION_ID,_0x57f39f),_0x205ae1=await this.#getFixes(_0x57f39f);return{'submission':_0x4a09ff,'fixes':_0x205ae1};}async[a0_0x2a2632(0x117)](_0x47dcf1){await this.#deleteSubmissionGroup(_0x47dcf1);}async[a0_0x2a2632(0x10d)](_0x140722,_0x153a5e){const _0x1d1975=a0_0x2a2632;return this.#databases[_0x1d1975(0xf6)](DATABASE_ID,SUBMISSIONS_COLLECTION_ID,_0x140722,{'graded':_0x153a5e});}async[a0_0x2a2632(0x109)](){const _0x103941=a0_0x2a2632,_0x8bd5f0=await this.#databases[_0x103941(0x10a)](DATABASE_ID,SUBMISSIONS_COLLECTION_ID),_0x746a13=[];for(const _0x2e3a0f of _0x8bd5f0[_0x103941(0x103)]){const _0x583830=await this.#getFixes(_0x2e3a0f[_0x103941(0x10f)]);_0x746a13[_0x103941(0xfb)]({..._0x2e3a0f,'fixes':_0x583830[_0x103941(0x103)]});}return _0x746a13;}#submissionId({studentID:_0x1bb155,projectNumber:_0x1b6f6f}){return _0x1bb155+'-'+_0x1b6f6f;}async #docPermissions(){const _0x2b0791=a0_0x2a2632;let _0x866b14=[];const _0x2364d3=await auth[_0x2b0791(0xf4)]();if(_0x2364d3){const _0x29e709=_0x2364d3[_0x2b0791(0x10f)];_0x866b14=[Permission['read'](Role[_0x2b0791(0x107)](_0x29e709)),Permission[_0x2b0791(0xfc)](Role['user'](_0x29e709)),Permission['delete'](Role[_0x2b0791(0x107)](_0x29e709))];}return _0x866b14;}async #uploadFiles(_0x1dcf55){const _0xae0f69=a0_0x2a2632,_0x1f3ab2=new Map();for(const _0x3b2bc3 of _0x1dcf55){if(_0x1f3ab2[_0xae0f69(0x119)](_0x3b2bc3[_0xae0f69(0x114)][_0xae0f69(0x112)]))continue;const _0x1ea82f=await this.#docPermissions(),_0x1082a9=await this.#storage['createFile'](STORAGE_BUCKET_ID,ID['unique'](),_0x3b2bc3[_0xae0f69(0x114)],_0x1ea82f);_0x1f3ab2[_0xae0f69(0xff)](_0x3b2bc3[_0xae0f69(0x114)][_0xae0f69(0x112)],_0x1082a9);}return _0x1f3ab2;}async #createFixes(_0x30d5b8,_0x4dc262,_0x3d8066){const _0x53a37d=a0_0x2a2632,_0x119a13=[];for(const _0x133460 of _0x4dc262){const _0x30b6e6=_0x3d8066[_0x53a37d(0x116)](_0x133460[_0x53a37d(0x114)][_0x53a37d(0x112)]),_0x140f6c=await this.#docPermissions(),_0x1ecc32=await this.#databases[_0x53a37d(0x100)](DATABASE_ID,FIXES_COLLECTION_ID,ID[_0x53a37d(0x102)](),{'submissionId':_0x30d5b8,'fileName':_0x30b6e6[_0x53a37d(0x112)],'fileId':_0x30b6e6[_0x53a37d(0x10f)],'lineNumber':_0x133460[_0x53a37d(0xfd)],'deduction':_0x133460[_0x53a37d(0x111)],'eligiblePoints':_0x133460[_0x53a37d(0xf5)]},_0x140f6c);_0x119a13['push'](_0x1ecc32);}return _0x119a13;}async #getFixes(_0x48de51){const _0x5b9b56=a0_0x2a2632;return this.#databases[_0x5b9b56(0x10a)](DATABASE_ID,FIXES_COLLECTION_ID,[Query[_0x5b9b56(0x104)](_0x5b9b56(0x113),_0x48de51)]);}async #deleteSubmissionGroup(_0x396d13){const _0x225b93=a0_0x2a2632,_0x48852e=await this.#getFixes(_0x396d13);for(const _0x351b76 of _0x48852e[_0x225b93(0x103)]){await this.#storage[_0x225b93(0x110)](STORAGE_BUCKET_ID,_0x351b76[_0x225b93(0xf2)])[_0x225b93(0xf9)](()=>{});}for(const _0x23693c of _0x48852e[_0x225b93(0x103)]){await this.#databases[_0x225b93(0x105)](DATABASE_ID,FIXES_COLLECTION_ID,_0x23693c[_0x225b93(0x10f)])['catch'](()=>{});}await this.#databases[_0x225b93(0x105)](DATABASE_ID,SUBMISSIONS_COLLECTION_ID,_0x396d13)[_0x225b93(0xf9)](()=>{});}#computeSummary(_0x900167){const _0x10ffb4=a0_0x2a2632;return{'fixCount':_0x900167[_0x10ffb4(0xed)],'totalEligible':_0x900167[_0x10ffb4(0xfa)]((_0x3b6a29,_0x43e000)=>_0x3b6a29+_0x43e000[_0x10ffb4(0xf5)],0x0),'totalDeductions':_0x900167[_0x10ffb4(0xfa)]((_0x5dde9e,_0xa26586)=>_0x5dde9e+_0xa26586[_0x10ffb4(0x111)],0x0)};}}export const db=new SubmissionService(client);