const a0_0x13eab3=a0_0x3148;(function(_0x61f3b,_0x569527){const _0x318f1f=a0_0x3148,_0x4e8043=_0x61f3b();while(!![]){try{const _0x49c973=-parseInt(_0x318f1f(0x14a))/0x1*(-parseInt(_0x318f1f(0x12f))/0x2)+parseInt(_0x318f1f(0x150))/0x3+parseInt(_0x318f1f(0x13d))/0x4*(-parseInt(_0x318f1f(0x147))/0x5)+parseInt(_0x318f1f(0x134))/0x6*(parseInt(_0x318f1f(0x138))/0x7)+-parseInt(_0x318f1f(0x152))/0x8+parseInt(_0x318f1f(0x149))/0x9+parseInt(_0x318f1f(0x151))/0xa;if(_0x49c973===_0x569527)break;else _0x4e8043['push'](_0x4e8043['shift']());}catch(_0xd009bf){_0x4e8043['push'](_0x4e8043['shift']());}}}(a0_0x5263,0xbb428));function a0_0x3148(_0x121ae2,_0x4729e4){const _0x5263c4=a0_0x5263();return a0_0x3148=function(_0x314895,_0x5b4882){_0x314895=_0x314895-0x12f;let _0x3d2207=_0x5263c4[_0x314895];return _0x3d2207;},a0_0x3148(_0x121ae2,_0x4729e4);}import{auth}from'./auth.js';import{client,Databases,Storage,ID,Permission,Role,Query}from'./appwrite.js';const DATABASE_ID=a0_0x13eab3(0x130),SUBMISSIONS_COLLECTION_ID=a0_0x13eab3(0x143),FIXES_COLLECTION_ID='fixes',STORAGE_BUCKET_ID=a0_0x13eab3(0x140);class SubmissionService{#databases;#storage;constructor(_0x31251e){this.#databases=new Databases(_0x31251e),this.#storage=new Storage(_0x31251e);}async['createSubmission'](_0x205f2c,_0x22d101){const _0x166603=a0_0x13eab3,_0x41c52b=this.#submissionId(_0x205f2c);await this.#deleteSubmissionGroup(_0x41c52b);const _0x163b4e=await this.#uploadFiles(_0x22d101),_0x26f76b=await this.#createFixes(_0x41c52b,_0x22d101,_0x163b4e),_0x279c89=this.#computeSummary(_0x26f76b),_0x3e29ca=await this.#docPermissions();return await this.#databases[_0x166603(0x13e)](DATABASE_ID,SUBMISSIONS_COLLECTION_ID,_0x41c52b,{..._0x205f2c,..._0x279c89},_0x3e29ca),_0x41c52b;}async['readSubmission'](_0x3e23f9){const _0x5bbdc4=await this.#databases['getDocument'](DATABASE_ID,SUBMISSIONS_COLLECTION_ID,_0x3e23f9),_0x5907a5=await this.#getFixes(_0x3e23f9);return{'submission':_0x5bbdc4,'fixes':_0x5907a5};}async[a0_0x13eab3(0x14c)](_0x2e8ca5){await this.#deleteSubmissionGroup(_0x2e8ca5);}async[a0_0x13eab3(0x141)](_0x482787,_0x500348){return this.#databases['updateDocument'](DATABASE_ID,SUBMISSIONS_COLLECTION_ID,_0x482787,{'graded':_0x500348});}async[a0_0x13eab3(0x13a)](){const _0x477131=a0_0x13eab3,_0x54573f=await this.#databases[_0x477131(0x135)](DATABASE_ID,SUBMISSIONS_COLLECTION_ID),_0x378419=[];for(const _0x3c5219 of _0x54573f[_0x477131(0x13c)]){const _0x41664f=await this.#getFixes(_0x3c5219['$id']);_0x378419['push']({..._0x3c5219,'fixes':_0x41664f[_0x477131(0x13c)]});}return _0x378419;}#submissionId({studentID:_0x223ccd,projectNumber:_0x4bb8b8}){return _0x223ccd+'-'+_0x4bb8b8;}async #docPermissions(){const _0x2311f9=a0_0x13eab3;let _0x1d443c=[];const _0x320ea1=await auth[_0x2311f9(0x139)]();if(_0x320ea1){const _0x5b18a6=_0x320ea1[_0x2311f9(0x132)];_0x1d443c=[Permission[_0x2311f9(0x14d)](Role[_0x2311f9(0x148)](_0x5b18a6)),Permission['update'](Role[_0x2311f9(0x148)](_0x5b18a6)),Permission[_0x2311f9(0x131)](Role[_0x2311f9(0x148)](_0x5b18a6))];}return _0x1d443c;}async #uploadFiles(_0x43e054){const _0x475264=a0_0x13eab3,_0x222e31=new Map();for(const _0x3b746c of _0x43e054){if(_0x222e31['has'](_0x3b746c[_0x475264(0x142)][_0x475264(0x144)]))continue;const _0x28da41=await this.#docPermissions(),_0x1b8753=await this.#storage['createFile'](STORAGE_BUCKET_ID,ID[_0x475264(0x14e)](),_0x3b746c['file'],_0x28da41);_0x222e31['set'](_0x3b746c[_0x475264(0x142)][_0x475264(0x144)],_0x1b8753);}return _0x222e31;}async #createFixes(_0x42d191,_0x35bd14,_0x432881){const _0x4d87b4=a0_0x13eab3,_0x454a3b=[];for(const _0x2603bc of _0x35bd14){const _0x1938f6=_0x432881[_0x4d87b4(0x13f)](_0x2603bc[_0x4d87b4(0x142)][_0x4d87b4(0x144)]),_0x105138=await this.#docPermissions(),_0x2e3dbf=await this.#databases[_0x4d87b4(0x13e)](DATABASE_ID,FIXES_COLLECTION_ID,ID[_0x4d87b4(0x14e)](),{'submissionId':_0x42d191,'fileName':_0x1938f6[_0x4d87b4(0x144)],'fileId':_0x1938f6['$id'],'lineNumber':_0x2603bc[_0x4d87b4(0x153)],'deduction':_0x2603bc[_0x4d87b4(0x136)],'eligiblePoints':_0x2603bc[_0x4d87b4(0x14f)]},_0x105138);_0x454a3b['push'](_0x2e3dbf);}return _0x454a3b;}async #getFixes(_0x368e6b){const _0xa89981=a0_0x13eab3;return this.#databases[_0xa89981(0x135)](DATABASE_ID,FIXES_COLLECTION_ID,[Query[_0xa89981(0x137)](_0xa89981(0x13b),_0x368e6b)]);}async #deleteSubmissionGroup(_0x4d7f87){const _0x3078e4=a0_0x13eab3,_0x1940e5=await this.#getFixes(_0x4d7f87);for(const _0x6a0b20 of _0x1940e5[_0x3078e4(0x13c)]){await this.#storage[_0x3078e4(0x146)](STORAGE_BUCKET_ID,_0x6a0b20['fileId'])[_0x3078e4(0x14b)](()=>{});}for(const _0x1d6ced of _0x1940e5[_0x3078e4(0x13c)]){await this.#databases[_0x3078e4(0x145)](DATABASE_ID,FIXES_COLLECTION_ID,_0x1d6ced['$id'])[_0x3078e4(0x14b)](()=>{});}await this.#databases[_0x3078e4(0x145)](DATABASE_ID,SUBMISSIONS_COLLECTION_ID,_0x4d7f87)['catch'](()=>{});}#computeSummary(_0x29b8f2){const _0x230a7a=a0_0x13eab3;return{'fixCount':_0x29b8f2['length'],'totalEligible':_0x29b8f2[_0x230a7a(0x133)]((_0x405d7f,_0x203c53)=>_0x405d7f+_0x203c53['eligiblePoints'],0x0),'totalDeductions':_0x29b8f2['reduce']((_0xa13c65,_0x45324a)=>_0xa13c65+_0x45324a[_0x230a7a(0x136)],0x0)};}}function a0_0x5263(){const _0x136bf6=['submissionId','documents','12NFgmTN','createDocument','get','6945a9930023af1a7139','updateSubmissionGraded','file','submissions','name','deleteDocument','deleteFile','1201610XCseNU','user','1467072IyAfjE','588359HfrgrV','catch','deleteSubmission','read','unique','eligiblePoints','2109231NYJsts','1457010GUCSYY','1495448GgDAqe','lineNumber','2MZflne','6945a6580034b3c579df','delete','$id','reduce','56076KLZJgG','listDocuments','deduction','equal','56krzPBD','getUser','listSubmissions'];a0_0x5263=function(){return _0x136bf6;};return a0_0x5263();}export const db=new SubmissionService(client);