const a0_0x1b3d11=a0_0x31f7;(function(_0x40366b,_0x2295b6){const _0x306b89=a0_0x31f7,_0x105c5e=_0x40366b();while(!![]){try{const _0x31dd41=-parseInt(_0x306b89(0x15b))/0x1*(parseInt(_0x306b89(0x169))/0x2)+parseInt(_0x306b89(0x156))/0x3+-parseInt(_0x306b89(0x147))/0x4+-parseInt(_0x306b89(0x16c))/0x5+parseInt(_0x306b89(0x15a))/0x6*(-parseInt(_0x306b89(0x14b))/0x7)+parseInt(_0x306b89(0x153))/0x8+parseInt(_0x306b89(0x164))/0x9*(parseInt(_0x306b89(0x161))/0xa);if(_0x31dd41===_0x2295b6)break;else _0x105c5e['push'](_0x105c5e['shift']());}catch(_0x3fe9d0){_0x105c5e['push'](_0x105c5e['shift']());}}}(a0_0x3bf5,0xee0a9));import{auth}from'./auth.js';import{client,Databases,Storage,ID,Permission,Role,Query}from'./appwrite.js';function a0_0x31f7(_0x4d9c14,_0x5b3ef2){const _0x3bf597=a0_0x3bf5();return a0_0x31f7=function(_0x31f7ca,_0x54b6fb){_0x31f7ca=_0x31f7ca-0x147;let _0x11129b=_0x3bf597[_0x31f7ca];return _0x11129b;},a0_0x31f7(_0x4d9c14,_0x5b3ef2);}const DATABASE_ID='6945a6580034b3c579df',SUBMISSIONS_COLLECTION_ID='submissions',FIXES_COLLECTION_ID='fixes',STORAGE_BUCKET_ID='6945a9930023af1a7139';function a0_0x3bf5(){const _0x403ba8=['lineNumber','13902184IVhbWN','readSubmission','fileId','5034015OlmLYb','updateDocument','deleteDocument','submissionId','261342YoVItM','762154aXPLtn','catch','delete','unique','createSubmission','deduction','89470MrfGNo','read','updateSubmissionGraded','2106mTIQjJ','documents','has','push','deleteSubmission','2smzHag','deleteFile','listDocuments','7081245rhieWF','getDocument','getUser','createDocument','file','createFile','reduce','4719668bUbMMT','update','$id','length','189jWHbLR','user','eligiblePoints','listSubmissions','name','set','equal'];a0_0x3bf5=function(){return _0x403ba8;};return a0_0x3bf5();}class SubmissionService{#databases;#storage;constructor(_0x124f86){this.#databases=new Databases(_0x124f86),this.#storage=new Storage(_0x124f86);}async[a0_0x1b3d11(0x15f)](_0x579cf3,_0x1aefaa){const _0xb47394=a0_0x1b3d11,_0x55617b=this.#submissionId(_0x579cf3);await this.#deleteSubmissionGroup(_0x55617b);const _0x35340b=await this.#uploadFiles(_0x1aefaa),_0x2f5b44=await this.#createFixes(_0x55617b,_0x1aefaa,_0x35340b),_0x2b4c14=this.#computeSummary(_0x2f5b44),_0x38e00a=await this.#docPermissions();return await this.#databases[_0xb47394(0x16f)](DATABASE_ID,SUBMISSIONS_COLLECTION_ID,_0x55617b,{..._0x579cf3,..._0x2b4c14},_0x38e00a),_0x55617b;}async[a0_0x1b3d11(0x154)](_0x8a7736){const _0x43f047=a0_0x1b3d11,_0x42d745=await this.#databases[_0x43f047(0x16d)](DATABASE_ID,SUBMISSIONS_COLLECTION_ID,_0x8a7736),_0x2a6040=await this.#getFixes(_0x8a7736);return{'submission':_0x42d745,'fixes':_0x2a6040};}async[a0_0x1b3d11(0x168)](_0x157dd9){await this.#deleteSubmissionGroup(_0x157dd9);}async[a0_0x1b3d11(0x163)](_0x12f3c6,_0x50a381){const _0x369490=a0_0x1b3d11;return this.#databases[_0x369490(0x157)](DATABASE_ID,SUBMISSIONS_COLLECTION_ID,_0x12f3c6,{'graded':_0x50a381});}async[a0_0x1b3d11(0x14e)](){const _0x1823eb=a0_0x1b3d11,_0x5b9c30=await this.#databases[_0x1823eb(0x16b)](DATABASE_ID,SUBMISSIONS_COLLECTION_ID),_0x5a55b0=[];for(const _0x26934a of _0x5b9c30[_0x1823eb(0x165)]){const _0x20b0ef=await this.#getFixes(_0x26934a['$id']);_0x5a55b0[_0x1823eb(0x167)]({..._0x26934a,'fixes':_0x20b0ef[_0x1823eb(0x165)]});}return _0x5a55b0;}#submissionId({studentID:_0xc97ef4,projectNumber:_0x2e565a}){return _0xc97ef4+'-'+_0x2e565a;}async #docPermissions(){const _0x3971b9=a0_0x1b3d11;let _0x52e6d2=[];const _0xebcede=await auth[_0x3971b9(0x16e)]();if(_0xebcede){const _0x16f106=_0xebcede[_0x3971b9(0x149)];_0x52e6d2=[Permission[_0x3971b9(0x162)](Role[_0x3971b9(0x14c)](_0x16f106)),Permission[_0x3971b9(0x148)](Role['user'](_0x16f106)),Permission[_0x3971b9(0x15d)](Role[_0x3971b9(0x14c)](_0x16f106))];}return _0x52e6d2;}async #uploadFiles(_0x4e72c8){const _0xeaebb9=a0_0x1b3d11,_0x19fbf5=new Map();for(const _0x19b8cd of _0x4e72c8){if(_0x19fbf5[_0xeaebb9(0x166)](_0x19b8cd['file']['name']))continue;const _0x5c3564=await this.#docPermissions(),_0x5cc50f=await this.#storage[_0xeaebb9(0x171)](STORAGE_BUCKET_ID,ID['unique'](),_0x19b8cd[_0xeaebb9(0x170)],_0x5c3564);_0x19fbf5[_0xeaebb9(0x150)](_0x19b8cd['file'][_0xeaebb9(0x14f)],_0x5cc50f);}return _0x19fbf5;}async #createFixes(_0x2e3652,_0x412723,_0x130067){const _0x406a6e=a0_0x1b3d11,_0x5639de=[];for(const _0x159333 of _0x412723){const _0x79efaf=_0x130067['get'](_0x159333[_0x406a6e(0x170)][_0x406a6e(0x14f)]),_0x1f32c2=await this.#docPermissions(),_0x5d2e2d=await this.#databases[_0x406a6e(0x16f)](DATABASE_ID,FIXES_COLLECTION_ID,ID[_0x406a6e(0x15e)](),{'submissionId':_0x2e3652,'fileName':_0x79efaf['name'],'fileId':_0x79efaf[_0x406a6e(0x149)],'lineNumber':_0x159333[_0x406a6e(0x152)],'deduction':_0x159333[_0x406a6e(0x160)],'eligiblePoints':_0x159333[_0x406a6e(0x14d)]},_0x1f32c2);_0x5639de['push'](_0x5d2e2d);}return _0x5639de;}async #getFixes(_0x475d1d){const _0x3b7a4a=a0_0x1b3d11;return this.#databases['listDocuments'](DATABASE_ID,FIXES_COLLECTION_ID,[Query[_0x3b7a4a(0x151)](_0x3b7a4a(0x159),_0x475d1d)]);}async #deleteSubmissionGroup(_0x2fae6e){const _0x43af42=a0_0x1b3d11,_0x29e6c4=await this.#getFixes(_0x2fae6e);for(const _0x5c6bc8 of _0x29e6c4[_0x43af42(0x165)]){await this.#storage[_0x43af42(0x16a)](STORAGE_BUCKET_ID,_0x5c6bc8[_0x43af42(0x155)])['catch'](()=>{});}for(const _0x189e20 of _0x29e6c4[_0x43af42(0x165)]){await this.#databases['deleteDocument'](DATABASE_ID,FIXES_COLLECTION_ID,_0x189e20[_0x43af42(0x149)])[_0x43af42(0x15c)](()=>{});}await this.#databases[_0x43af42(0x158)](DATABASE_ID,SUBMISSIONS_COLLECTION_ID,_0x2fae6e)['catch'](()=>{});}#computeSummary(_0x3d0962){const _0x7bbe1f=a0_0x1b3d11;return{'fixCount':_0x3d0962[_0x7bbe1f(0x14a)],'totalEligible':_0x3d0962[_0x7bbe1f(0x172)]((_0x24ac8e,_0x51718b)=>_0x24ac8e+_0x51718b[_0x7bbe1f(0x14d)],0x0),'totalDeductions':_0x3d0962['reduce']((_0x383730,_0x443e7e)=>_0x383730+_0x443e7e['deduction'],0x0)};}}export const db=new SubmissionService(client);