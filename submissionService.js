const a0_0x1894dd=a0_0x285c;(function(_0x30c629,_0x4ac36f){const _0x2096d4=a0_0x285c,_0x1d4bfc=_0x30c629();while(!![]){try{const _0x19e0e0=parseInt(_0x2096d4(0x1ec))/0x1*(-parseInt(_0x2096d4(0x1d0))/0x2)+parseInt(_0x2096d4(0x1cc))/0x3*(-parseInt(_0x2096d4(0x1c8))/0x4)+-parseInt(_0x2096d4(0x1de))/0x5*(parseInt(_0x2096d4(0x1e8))/0x6)+parseInt(_0x2096d4(0x1d5))/0x7*(-parseInt(_0x2096d4(0x1d4))/0x8)+-parseInt(_0x2096d4(0x1e4))/0x9+parseInt(_0x2096d4(0x1cb))/0xa+parseInt(_0x2096d4(0x1da))/0xb;if(_0x19e0e0===_0x4ac36f)break;else _0x1d4bfc['push'](_0x1d4bfc['shift']());}catch(_0x99ad79){_0x1d4bfc['push'](_0x1d4bfc['shift']());}}}(a0_0x4dfe,0xb07df));function a0_0x285c(_0xd92059,_0x4e82b0){const _0x4dfe34=a0_0x4dfe();return a0_0x285c=function(_0x285ccb,_0x53e1c5){_0x285ccb=_0x285ccb-0x1c4;let _0x243446=_0x4dfe34[_0x285ccb];return _0x243446;},a0_0x285c(_0xd92059,_0x4e82b0);}import{auth}from'./auth.js';import{client,Databases,Storage,ID,Permission,Role,Query}from'./appwrite.js';function a0_0x4dfe(){const _0x29964b=['lineNumber','4268BiXhMr','submissions','createSubmission','5854300YLjVtC','2286SKBZWC','deduction','createDocument','readSubmission','2286HQGRML','file','fileId','fixes','5714528UaAcgc','7wEumwU','has','catch','getUser','getDocument','32777624aNJfjQ','delete','submissionId','equal','2038615LkFEif','name','documents','updateSubmissionGraded','listDocuments','zybookStudents','298287lShoxB','get','$id','push','12XawFRx','set','updateDocument','listSubmissions','408cOOHsJ','unique','deleteSubmission','reduce','length','zybookStudent','read','createFile','user'];a0_0x4dfe=function(){return _0x29964b;};return a0_0x4dfe();}const DATABASE_ID='6945a6580034b3c579df',SUBMISSIONS_COLLECTION_ID=a0_0x1894dd(0x1c9),FIXES_COLLECTION_ID=a0_0x1894dd(0x1d3),ZYBOOK_STUDENTS_COLLECTION_ID=a0_0x1894dd(0x1e3),STORAGE_BUCKET_ID='6945a9930023af1a7139';class SubmissionService{#databases;#storage;constructor(_0x5c59fa){this.#databases=new Databases(_0x5c59fa),this.#storage=new Storage(_0x5c59fa);}async[a0_0x1894dd(0x1ca)](_0x468b4e,_0x2d1bf2){const _0x535275=a0_0x1894dd,_0x4d358a=this.#submissionId(_0x468b4e);await this.#deleteSubmissionGroup(_0x4d358a);const _0x41a120=await this.#uploadFiles(_0x2d1bf2),_0x117f4b=await this.#createFixes(_0x4d358a,_0x2d1bf2,_0x41a120),_0x2af267=this.#computeSummary(_0x117f4b),_0x5f107a=await this.#docPermissions();return await this.#databases[_0x535275(0x1ce)](DATABASE_ID,SUBMISSIONS_COLLECTION_ID,_0x4d358a,{..._0x468b4e,..._0x2af267},_0x5f107a),_0x4d358a;}async[a0_0x1894dd(0x1cf)](_0x29c86e){const _0x483964=a0_0x1894dd,_0x1f26a6=await this.#databases[_0x483964(0x1d9)](DATABASE_ID,SUBMISSIONS_COLLECTION_ID,_0x29c86e),_0x5889aa=await this.#getFixes(_0x29c86e);return{'submission':_0x1f26a6,'fixes':_0x5889aa};}async[a0_0x1894dd(0x1ee)](_0x2bf631){await this.#deleteSubmissionGroup(_0x2bf631);}async[a0_0x1894dd(0x1e1)](_0x3cc62a,_0x40ac46){const _0x3ade34=a0_0x1894dd;return this.#databases[_0x3ade34(0x1ea)](DATABASE_ID,SUBMISSIONS_COLLECTION_ID,_0x3cc62a,{'graded':_0x40ac46});}async[a0_0x1894dd(0x1eb)](){const _0x19fa9d=a0_0x1894dd,_0x483c73=await this.#databases[_0x19fa9d(0x1e2)](DATABASE_ID,SUBMISSIONS_COLLECTION_ID),_0x4c2bd9=[];for(const _0x305a62 of _0x483c73['documents']){const _0x980495=await this.#getFixes(_0x305a62[_0x19fa9d(0x1e6)]);_0x4c2bd9[_0x19fa9d(0x1e7)]({..._0x305a62,'fixes':_0x980495[_0x19fa9d(0x1e0)]});}return _0x4c2bd9;}async[a0_0x1894dd(0x1f1)](_0x2f9c56){const _0x2e0c73=a0_0x1894dd,_0x4cb216=await this.#databases[_0x2e0c73(0x1e2)](DATABASE_ID,ZYBOOK_STUDENTS_COLLECTION_ID,[Query['equal']('canvasId',_0x2f9c56)]);return _0x4cb216['documents'][0x0]??null;}#submissionId({studentID:_0x315429,projectNumber:_0x3db8f9}){return _0x315429+'-'+_0x3db8f9;}async #docPermissions(){const _0x32c7b1=a0_0x1894dd;let _0x4cabf7=[];const _0x194e66=await auth[_0x32c7b1(0x1d8)]();if(_0x194e66){const _0x71c1f5=_0x194e66[_0x32c7b1(0x1e6)];_0x4cabf7=[Permission[_0x32c7b1(0x1c4)](Role[_0x32c7b1(0x1c6)](_0x71c1f5)),Permission['update'](Role[_0x32c7b1(0x1c6)](_0x71c1f5)),Permission[_0x32c7b1(0x1db)](Role[_0x32c7b1(0x1c6)](_0x71c1f5))];}return _0x4cabf7;}async #uploadFiles(_0x2eda6f){const _0x5a52bb=a0_0x1894dd,_0x4d612a=new Map();for(const _0x19431f of _0x2eda6f){if(_0x4d612a[_0x5a52bb(0x1d6)](_0x19431f[_0x5a52bb(0x1d1)][_0x5a52bb(0x1df)]))continue;const _0xb4179=await this.#docPermissions(),_0xd0c4ce=await this.#storage[_0x5a52bb(0x1c5)](STORAGE_BUCKET_ID,ID[_0x5a52bb(0x1ed)](),_0x19431f[_0x5a52bb(0x1d1)],_0xb4179);_0x4d612a[_0x5a52bb(0x1e9)](_0x19431f['file'][_0x5a52bb(0x1df)],_0xd0c4ce);}return _0x4d612a;}async #createFixes(_0x502953,_0x5a406d,_0x4646cb){const _0x2bc604=a0_0x1894dd,_0x5a75b5=[];for(const _0x4b878e of _0x5a406d){const _0x3cc224=_0x4646cb[_0x2bc604(0x1e5)](_0x4b878e[_0x2bc604(0x1d1)][_0x2bc604(0x1df)]),_0x590bef=await this.#docPermissions(),_0x3b5579=await this.#databases[_0x2bc604(0x1ce)](DATABASE_ID,FIXES_COLLECTION_ID,ID[_0x2bc604(0x1ed)](),{'submissionId':_0x502953,'fileName':_0x3cc224[_0x2bc604(0x1df)],'fileId':_0x3cc224['$id'],'lineNumber':_0x4b878e[_0x2bc604(0x1c7)],'deduction':_0x4b878e[_0x2bc604(0x1cd)],'eligiblePoints':_0x4b878e['eligiblePoints']},_0x590bef);_0x5a75b5[_0x2bc604(0x1e7)](_0x3b5579);}return _0x5a75b5;}async #getFixes(_0x2d6c97){const _0x4b8adf=a0_0x1894dd;return this.#databases[_0x4b8adf(0x1e2)](DATABASE_ID,FIXES_COLLECTION_ID,[Query[_0x4b8adf(0x1dd)](_0x4b8adf(0x1dc),_0x2d6c97)]);}async #deleteSubmissionGroup(_0x470589){const _0x3001c5=a0_0x1894dd,_0x1deb07=await this.#getFixes(_0x470589);for(const _0x56693c of _0x1deb07[_0x3001c5(0x1e0)]){await this.#storage['deleteFile'](STORAGE_BUCKET_ID,_0x56693c[_0x3001c5(0x1d2)])['catch'](()=>{});}for(const _0x516d8f of _0x1deb07[_0x3001c5(0x1e0)]){await this.#databases['deleteDocument'](DATABASE_ID,FIXES_COLLECTION_ID,_0x516d8f[_0x3001c5(0x1e6)])[_0x3001c5(0x1d7)](()=>{});}await this.#databases['deleteDocument'](DATABASE_ID,SUBMISSIONS_COLLECTION_ID,_0x470589)[_0x3001c5(0x1d7)](()=>{});}#computeSummary(_0x44329f){const _0x10c5d9=a0_0x1894dd;return{'fixCount':_0x44329f[_0x10c5d9(0x1f0)],'totalEligible':_0x44329f[_0x10c5d9(0x1ef)]((_0x363b4d,_0x57a3c6)=>_0x363b4d+_0x57a3c6['eligiblePoints'],0x0),'totalDeductions':_0x44329f[_0x10c5d9(0x1ef)]((_0x44d67f,_0x501572)=>_0x44d67f+_0x501572['deduction'],0x0)};}}export const db=new SubmissionService(client);