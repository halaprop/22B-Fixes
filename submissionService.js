const a0_0x5b9867=a0_0x2d42;(function(_0x4a46dd,_0x5d9de9){const _0x3c7f9f=a0_0x2d42,_0x5ed5fb=_0x4a46dd();while(!![]){try{const _0x25a01e=parseInt(_0x3c7f9f(0x1a9))/0x1+parseInt(_0x3c7f9f(0x1b5))/0x2+parseInt(_0x3c7f9f(0x1a8))/0x3+parseInt(_0x3c7f9f(0x19b))/0x4+parseInt(_0x3c7f9f(0x1b0))/0x5+-parseInt(_0x3c7f9f(0x1a7))/0x6+parseInt(_0x3c7f9f(0x1b2))/0x7*(-parseInt(_0x3c7f9f(0x1a1))/0x8);if(_0x25a01e===_0x5d9de9)break;else _0x5ed5fb['push'](_0x5ed5fb['shift']());}catch(_0x4ac84a){_0x5ed5fb['push'](_0x5ed5fb['shift']());}}}(a0_0x2bcc,0x36af8));function a0_0x2d42(_0x53bb42,_0x162b66){const _0x2bcc5f=a0_0x2bcc();return a0_0x2d42=function(_0x2d42b7,_0x4da00b){_0x2d42b7=_0x2d42b7-0x197;let _0x253650=_0x2bcc5f[_0x2d42b7];return _0x253650;},a0_0x2d42(_0x53bb42,_0x162b66);}import{auth}from'./auth.js';function a0_0x2bcc(){const _0x417813=['catch','listDocuments','1543880MiYEhe','push','reduce','6945a6580034b3c579df','deleteFile','createFile','2168YZGWVP','documents','eligiblePoints','file','submissionId','createDocument','1999866QjtuRq','550698aZFjLK','407969gxpqXW','fixes','get','fileId','user','lineNumber','$id','239585OFoyjd','name','21987pLXjMl','readSubmission','deleteDocument','766184ezeJea','length','set','updateDocument','submissions','deduction','read','delete','unique','getUser','createSubmission','update'];a0_0x2bcc=function(){return _0x417813;};return a0_0x2bcc();}import{client,Databases,Storage,ID,Permission,Role,Query}from'./appwrite.js';const DATABASE_ID=a0_0x5b9867(0x19e),SUBMISSIONS_COLLECTION_ID=a0_0x5b9867(0x1b9),FIXES_COLLECTION_ID=a0_0x5b9867(0x1aa),STORAGE_BUCKET_ID='6945a9930023af1a7139';class SubmissionService{#databases;#storage;constructor(_0x3807c1){this.#databases=new Databases(_0x3807c1),this.#storage=new Storage(_0x3807c1);}async[a0_0x5b9867(0x197)](_0x441094,_0x1e500e){const _0x514733=this.#submissionId(_0x441094);await this.#deleteSubmissionGroup(_0x514733);const _0x11eb6f=await this.#uploadFiles(_0x1e500e),_0xaa2031=await this.#createFixes(_0x514733,_0x1e500e,_0x11eb6f),_0x5cc48e=this.#computeSummary(_0xaa2031),_0x1f826f=await this.#docPermissions();return await this.#databases['createDocument'](DATABASE_ID,SUBMISSIONS_COLLECTION_ID,_0x514733,{..._0x441094,..._0x5cc48e},_0x1f826f),_0x514733;}async[a0_0x5b9867(0x1b3)](_0x3bd79a){const _0x33d40e=await this.#databases['getDocument'](DATABASE_ID,SUBMISSIONS_COLLECTION_ID,_0x3bd79a),_0x2dace0=await this.#getFixes(_0x3bd79a);return{'submission':_0x33d40e,'fixes':_0x2dace0};}async['deleteSubmission'](_0x2ef254){await this.#deleteSubmissionGroup(_0x2ef254);}async['updateSubmissionGraded'](_0x130dc0,_0x5239d2){const _0x96e0c7=a0_0x5b9867;return this.#databases[_0x96e0c7(0x1b8)](DATABASE_ID,SUBMISSIONS_COLLECTION_ID,_0x130dc0,{'graded':_0x5239d2});}async['listSubmissions'](){const _0x170f1c=a0_0x5b9867,_0x2ce686=await this.#databases[_0x170f1c(0x19a)](DATABASE_ID,SUBMISSIONS_COLLECTION_ID),_0x6eeb01=[];for(const _0x50e2f6 of _0x2ce686[_0x170f1c(0x1a2)]){const _0x23affe=await this.#getFixes(_0x50e2f6[_0x170f1c(0x1af)]);_0x6eeb01[_0x170f1c(0x19c)]({..._0x50e2f6,'fixes':_0x23affe[_0x170f1c(0x1a2)]});}return _0x6eeb01;}#submissionId({studentID:_0x344965,projectNumber:_0xa43768}){return _0x344965+'-'+_0xa43768;}async #docPermissions(){const _0x20e892=a0_0x5b9867;let _0x55c586=[];const _0x1a4fef=await auth[_0x20e892(0x1be)]();if(_0x1a4fef){const _0x31b65c=_0x1a4fef[_0x20e892(0x1af)];_0x55c586=[Permission[_0x20e892(0x1bb)](Role[_0x20e892(0x1ad)](_0x31b65c)),Permission[_0x20e892(0x198)](Role[_0x20e892(0x1ad)](_0x31b65c)),Permission[_0x20e892(0x1bc)](Role[_0x20e892(0x1ad)](_0x31b65c))];}return _0x55c586;}async #uploadFiles(_0x1ab912){const _0x3687ca=a0_0x5b9867,_0x2539bf=new Map();for(const _0x90e877 of _0x1ab912){if(_0x2539bf['has'](_0x90e877[_0x3687ca(0x1a4)][_0x3687ca(0x1b1)]))continue;const _0x21e090=await this.#docPermissions(),_0x1da21e=await this.#storage[_0x3687ca(0x1a0)](STORAGE_BUCKET_ID,ID['unique'](),_0x90e877[_0x3687ca(0x1a4)],_0x21e090);_0x2539bf[_0x3687ca(0x1b7)](_0x90e877['file'][_0x3687ca(0x1b1)],_0x1da21e);}return _0x2539bf;}async #createFixes(_0x5d8a46,_0x18de8a,_0x27309c){const _0x3bdf85=a0_0x5b9867,_0x373a2d=[];for(const _0x213f83 of _0x18de8a){const _0x4f4704=_0x27309c[_0x3bdf85(0x1ab)](_0x213f83[_0x3bdf85(0x1a4)]['name']),_0x2bd274=await this.#docPermissions(),_0x1c7a46=await this.#databases[_0x3bdf85(0x1a6)](DATABASE_ID,FIXES_COLLECTION_ID,ID[_0x3bdf85(0x1bd)](),{'submissionId':_0x5d8a46,'fileName':_0x4f4704[_0x3bdf85(0x1b1)],'fileId':_0x4f4704[_0x3bdf85(0x1af)],'lineNumber':_0x213f83[_0x3bdf85(0x1ae)],'deduction':_0x213f83[_0x3bdf85(0x1ba)],'eligiblePoints':_0x213f83['eligiblePoints']},_0x2bd274);_0x373a2d[_0x3bdf85(0x19c)](_0x1c7a46);}return _0x373a2d;}async #getFixes(_0x5a0122){const _0x45041c=a0_0x5b9867;return this.#databases[_0x45041c(0x19a)](DATABASE_ID,FIXES_COLLECTION_ID,[Query['equal'](_0x45041c(0x1a5),_0x5a0122)]);}async #deleteSubmissionGroup(_0x354135){const _0x12893d=a0_0x5b9867,_0x305571=await this.#getFixes(_0x354135);for(const _0xccf3b1 of _0x305571[_0x12893d(0x1a2)]){await this.#storage[_0x12893d(0x19f)](STORAGE_BUCKET_ID,_0xccf3b1[_0x12893d(0x1ac)])['catch'](()=>{});}for(const _0x64dc8d of _0x305571[_0x12893d(0x1a2)]){await this.#databases[_0x12893d(0x1b4)](DATABASE_ID,FIXES_COLLECTION_ID,_0x64dc8d['$id'])[_0x12893d(0x199)](()=>{});}await this.#databases['deleteDocument'](DATABASE_ID,SUBMISSIONS_COLLECTION_ID,_0x354135)['catch'](()=>{});}#computeSummary(_0x5af577){const _0x13b614=a0_0x5b9867;return{'fixCount':_0x5af577[_0x13b614(0x1b6)],'totalEligible':_0x5af577[_0x13b614(0x19d)]((_0x3d0e86,_0x1d87b1)=>_0x3d0e86+_0x1d87b1[_0x13b614(0x1a3)],0x0),'totalDeductions':_0x5af577[_0x13b614(0x19d)]((_0x4c5048,_0x20645f)=>_0x4c5048+_0x20645f[_0x13b614(0x1ba)],0x0)};}}export const db=new SubmissionService(client);