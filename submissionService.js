const a0_0x486eae=a0_0x2e1a;function a0_0x2e1a(_0x223afb,_0x2fa2fc){const _0x178919=a0_0x1789();return a0_0x2e1a=function(_0x2e1a83,_0x125af4){_0x2e1a83=_0x2e1a83-0x81;let _0xb7fed4=_0x178919[_0x2e1a83];return _0xb7fed4;},a0_0x2e1a(_0x223afb,_0x2fa2fc);}(function(_0x498798,_0x251532){const _0x3f41da=a0_0x2e1a,_0x2b68b0=_0x498798();while(!![]){try{const _0x48ae82=-parseInt(_0x3f41da(0x9f))/0x1+parseInt(_0x3f41da(0x8a))/0x2+-parseInt(_0x3f41da(0x99))/0x3+-parseInt(_0x3f41da(0x9e))/0x4+-parseInt(_0x3f41da(0x91))/0x5+-parseInt(_0x3f41da(0x8b))/0x6+-parseInt(_0x3f41da(0xa5))/0x7*(-parseInt(_0x3f41da(0x83))/0x8);if(_0x48ae82===_0x251532)break;else _0x2b68b0['push'](_0x2b68b0['shift']());}catch(_0x401764){_0x2b68b0['push'](_0x2b68b0['shift']());}}}(a0_0x1789,0xd1b75));import{auth}from'./auth.js';import{client,Databases,Storage,ID,Permission,Role,Query}from'./appwrite.js';const DATABASE_ID=a0_0x486eae(0x9d),SUBMISSIONS_COLLECTION_ID='submissions',FIXES_COLLECTION_ID='fixes',ZYBOOK_STUDENTS_COLLECTION_ID=a0_0x486eae(0x96),STORAGE_BUCKET_ID=a0_0x486eae(0x87);class SubmissionService{#databases;#storage;constructor(_0x21cedf){this.#databases=new Databases(_0x21cedf),this.#storage=new Storage(_0x21cedf);}async[a0_0x486eae(0xa2)](_0xef962,_0x546222){const _0x1695c4=a0_0x486eae,_0x3d4887=this.#submissionId(_0xef962);await this.#deleteSubmissionGroup(_0x3d4887);const _0x14226b=await this.#uploadFiles(_0x546222),_0x424359=await this.#createFixes(_0x3d4887,_0x546222,_0x14226b),_0x4a85ea=this.#computeSummary(_0x424359),_0x583ced=await this.#docPermissions();return await this.#databases[_0x1695c4(0x84)](DATABASE_ID,SUBMISSIONS_COLLECTION_ID,_0x3d4887,{..._0xef962,..._0x4a85ea},_0x583ced),_0x3d4887;}async[a0_0x486eae(0x95)](_0x27c87c){const _0x243fbd=a0_0x486eae,_0x504c8a=await this.#databases[_0x243fbd(0xab)](DATABASE_ID,SUBMISSIONS_COLLECTION_ID,_0x27c87c),_0x2c1b84=await this.#getFixes(_0x27c87c);return{'submission':_0x504c8a,'fixes':_0x2c1b84};}async[a0_0x486eae(0xa3)](_0x46f360){await this.#deleteSubmissionGroup(_0x46f360);}async[a0_0x486eae(0x8f)](_0xaf73f7,_0x3c4ff6){const _0x1a161b=a0_0x486eae;return this.#databases[_0x1a161b(0x94)](DATABASE_ID,SUBMISSIONS_COLLECTION_ID,_0xaf73f7,{'graded':_0x3c4ff6});}async['listSubmissions'](){const _0x2bfe95=a0_0x486eae,_0x36beb4=await this.#databases[_0x2bfe95(0x92)](DATABASE_ID,SUBMISSIONS_COLLECTION_ID),_0x2f1c33=[];for(const _0x5e9225 of _0x36beb4[_0x2bfe95(0x9c)]){const _0x54be7d=await this.#getFixes(_0x5e9225[_0x2bfe95(0x9a)]);_0x2f1c33['push']({..._0x5e9225,'fixes':_0x54be7d[_0x2bfe95(0x9c)]});}return _0x2f1c33;}async[a0_0x486eae(0x85)](_0x33ec81){const _0xda6a73=a0_0x486eae,_0x4be5b6=await this.#databases[_0xda6a73(0x92)](DATABASE_ID,ZYBOOK_STUDENTS_COLLECTION_ID,[Query[_0xda6a73(0x89)](_0xda6a73(0x81),_0x33ec81)]);return _0x4be5b6[_0xda6a73(0x9c)][0x0]??null;}#submissionId({studentID:_0x1c2195,projectNumber:_0x4d94e2}){return _0x1c2195+'-'+_0x4d94e2;}async #docPermissions(){const _0x2183ba=a0_0x486eae;let _0x3ad4b1=[];const _0xbb31=await auth[_0x2183ba(0xaa)]();if(_0xbb31){const _0x9ccb47=_0xbb31[_0x2183ba(0x9a)];_0x3ad4b1=[Permission[_0x2183ba(0x97)](Role[_0x2183ba(0xa9)](_0x9ccb47)),Permission[_0x2183ba(0x8c)](Role[_0x2183ba(0xa9)](_0x9ccb47)),Permission[_0x2183ba(0x98)](Role[_0x2183ba(0xa9)](_0x9ccb47))];}return _0x3ad4b1;}async #uploadFiles(_0xb462e1){const _0x328bf5=a0_0x486eae,_0x55ac3a=new Map();for(const _0x3dcb64 of _0xb462e1){if(_0x55ac3a[_0x328bf5(0xac)](_0x3dcb64['file'][_0x328bf5(0xa0)]))continue;const _0x2f24b1=await this.#docPermissions(),_0x56a3bc=await this.#storage['createFile'](STORAGE_BUCKET_ID,ID['unique'](),_0x3dcb64[_0x328bf5(0x8e)],_0x2f24b1);_0x55ac3a[_0x328bf5(0xa8)](_0x3dcb64['file'][_0x328bf5(0xa0)],_0x56a3bc);}return _0x55ac3a;}async #createFixes(_0x312449,_0x1a28fb,_0x424c87){const _0x3e3e0a=a0_0x486eae,_0x1be7ca=[];for(const _0x5a6af0 of _0x1a28fb){const _0x36c963=_0x424c87['get'](_0x5a6af0[_0x3e3e0a(0x8e)][_0x3e3e0a(0xa0)]),_0x5f12a7=await this.#docPermissions(),_0xd4baae=await this.#databases['createDocument'](DATABASE_ID,FIXES_COLLECTION_ID,ID[_0x3e3e0a(0x82)](),{'submissionId':_0x312449,'fileName':_0x36c963[_0x3e3e0a(0xa0)],'fileId':_0x36c963[_0x3e3e0a(0x9a)],'lineNumber':_0x5a6af0[_0x3e3e0a(0xa1)],'deduction':_0x5a6af0[_0x3e3e0a(0x8d)],'eligiblePoints':_0x5a6af0[_0x3e3e0a(0xa7)]},_0x5f12a7);_0x1be7ca['push'](_0xd4baae);}return _0x1be7ca;}async #getFixes(_0x4d38c2){const _0xaf3bd7=a0_0x486eae;return this.#databases[_0xaf3bd7(0x92)](DATABASE_ID,FIXES_COLLECTION_ID,[Query['equal'](_0xaf3bd7(0x88),_0x4d38c2)]);}async #deleteSubmissionGroup(_0x2519ad){const _0xe424a0=a0_0x486eae,_0x81bd0f=await this.#getFixes(_0x2519ad);for(const _0x449a93 of _0x81bd0f[_0xe424a0(0x9c)]){await this.#storage[_0xe424a0(0x93)](STORAGE_BUCKET_ID,_0x449a93[_0xe424a0(0x9b)])[_0xe424a0(0xa4)](()=>{});}for(const _0x4f632d of _0x81bd0f[_0xe424a0(0x9c)]){await this.#databases['deleteDocument'](DATABASE_ID,FIXES_COLLECTION_ID,_0x4f632d[_0xe424a0(0x9a)])[_0xe424a0(0xa4)](()=>{});}await this.#databases[_0xe424a0(0x86)](DATABASE_ID,SUBMISSIONS_COLLECTION_ID,_0x2519ad)[_0xe424a0(0xa4)](()=>{});}#computeSummary(_0x535f8c){const _0xc267d9=a0_0x486eae;return{'fixCount':_0x535f8c[_0xc267d9(0xa6)],'totalEligible':_0x535f8c[_0xc267d9(0x90)]((_0x59a773,_0x4e39c0)=>_0x59a773+_0x4e39c0[_0xc267d9(0xa7)],0x0),'totalDeductions':_0x535f8c['reduce']((_0x4cecb2,_0x130198)=>_0x4cecb2+_0x130198[_0xc267d9(0x8d)],0x0)};}}export const db=new SubmissionService(client);function a0_0x1789(){const _0x4485c6=['equal','2050842WPsXKF','3789876JIkIgH','update','deduction','file','updateSubmissionGraded','reduce','8175680VRoUhQ','listDocuments','deleteFile','updateDocument','readSubmission','zybookStudents','read','delete','3721167YimGzg','$id','fileId','documents','6945a6580034b3c579df','231244zBOFHK','1197080hjYREL','name','lineNumber','createSubmission','deleteSubmission','catch','14wLJBGt','length','eligiblePoints','set','user','getUser','getDocument','has','canvasId','unique','18382552EvMxZc','createDocument','zybookStudent','deleteDocument','6945a9930023af1a7139','submissionId'];a0_0x1789=function(){return _0x4485c6;};return a0_0x1789();}