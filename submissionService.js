const a0_0x2bf109=a0_0x4314;(function(_0x4ac5b6,_0x51c562){const _0x238540=a0_0x4314,_0x23cfb7=_0x4ac5b6();while(!![]){try{const _0x206425=-parseInt(_0x238540(0x76))/0x1+-parseInt(_0x238540(0x75))/0x2+-parseInt(_0x238540(0x7e))/0x3+parseInt(_0x238540(0x8d))/0x4+parseInt(_0x238540(0x7f))/0x5*(-parseInt(_0x238540(0x87))/0x6)+-parseInt(_0x238540(0x80))/0x7*(parseInt(_0x238540(0x84))/0x8)+parseInt(_0x238540(0x73))/0x9*(parseInt(_0x238540(0x86))/0xa);if(_0x206425===_0x51c562)break;else _0x23cfb7['push'](_0x23cfb7['shift']());}catch(_0x2c1445){_0x23cfb7['push'](_0x23cfb7['shift']());}}}(a0_0x2797,0xdc012));import{auth}from'./auth.js';function a0_0x2797(){const _0x2db68c=['set','863658ZPCilz','catch','1604664OLKVMv','658600rihwuv','$id','equal','has','listDocuments','fileId','file','deduction','2959614eFSbZb','4153005GnwGqJ','29743owCsty','unique','createDocument','getUser','248fdDEsd','createFile','390qbfaxu','12JvFjNv','6945a9930023af1a7139','zybookStudent','update','deleteSubmission','user','5596044TiwSlA','zybookStudents','createSubmission','updateDocument','read','updateSubmissionGraded','delete','eligiblePoints','readSubmission','documents','deleteDocument','name','canvasId','reduce'];a0_0x2797=function(){return _0x2db68c;};return a0_0x2797();}function a0_0x4314(_0x564fb5,_0x484728){const _0x27976b=a0_0x2797();return a0_0x4314=function(_0x4314a5,_0x34e91d){_0x4314a5=_0x4314a5-0x6a;let _0x21646a=_0x27976b[_0x4314a5];return _0x21646a;},a0_0x4314(_0x564fb5,_0x484728);}import{client,Databases,Storage,ID,Permission,Role,Query}from'./appwrite.js';const DATABASE_ID='6945a6580034b3c579df',SUBMISSIONS_COLLECTION_ID='submissions',FIXES_COLLECTION_ID='fixes',ZYBOOK_STUDENTS_COLLECTION_ID=a0_0x2bf109(0x8e),STORAGE_BUCKET_ID=a0_0x2bf109(0x88);class SubmissionService{#databases;#storage;constructor(_0x492927){this.#databases=new Databases(_0x492927),this.#storage=new Storage(_0x492927);}async[a0_0x2bf109(0x8f)](_0x22e5bb,_0x2233f3){const _0x3a08c0=a0_0x2bf109,_0x37d769=this.#submissionId(_0x22e5bb);await this.#deleteSubmissionGroup(_0x37d769);const _0x4ae743=await this.#uploadFiles(_0x2233f3),_0x4e8bcc=await this.#createFixes(_0x37d769,_0x2233f3,_0x4ae743),_0x3941ee=this.#computeSummary(_0x4e8bcc),_0x798566=await this.#docPermissions();return await this.#databases[_0x3a08c0(0x82)](DATABASE_ID,SUBMISSIONS_COLLECTION_ID,_0x37d769,{..._0x22e5bb,..._0x3941ee},_0x798566),_0x37d769;}async[a0_0x2bf109(0x6c)](_0x4c8f6a){const _0x303b7f=await this.#databases['getDocument'](DATABASE_ID,SUBMISSIONS_COLLECTION_ID,_0x4c8f6a),_0x413785=await this.#getFixes(_0x4c8f6a);return{'submission':_0x303b7f,'fixes':_0x413785};}async[a0_0x2bf109(0x8b)](_0x3e35f1){await this.#deleteSubmissionGroup(_0x3e35f1);}async[a0_0x2bf109(0x92)](_0x516594,_0xa9644f){const _0x1a5577=a0_0x2bf109;return this.#databases[_0x1a5577(0x90)](DATABASE_ID,SUBMISSIONS_COLLECTION_ID,_0x516594,{'graded':_0xa9644f});}async['listSubmissions'](){const _0xb032d7=a0_0x2bf109,_0x182cac=await this.#databases[_0xb032d7(0x7a)](DATABASE_ID,SUBMISSIONS_COLLECTION_ID),_0xbb259f=[];for(const _0x112003 of _0x182cac['documents']){const _0x543626=await this.#getFixes(_0x112003[_0xb032d7(0x77)]);_0xbb259f['push']({..._0x112003,'fixes':_0x543626[_0xb032d7(0x6d)]});}return _0xbb259f;}async[a0_0x2bf109(0x89)](_0x3ed7a0){const _0x13fbfb=a0_0x2bf109,_0x19a474=await this.#databases[_0x13fbfb(0x7a)](DATABASE_ID,ZYBOOK_STUDENTS_COLLECTION_ID,[Query[_0x13fbfb(0x78)](_0x13fbfb(0x70),_0x3ed7a0)]);return _0x19a474['documents'][0x0]??null;}#submissionId({studentID:_0x150ee4,projectNumber:_0x5c3ba4}){return _0x150ee4+'-'+_0x5c3ba4;}async #docPermissions(){const _0x5d0c2b=a0_0x2bf109;let _0xb1948e=[];const _0x5ce044=await auth[_0x5d0c2b(0x83)]();if(_0x5ce044){const _0xca3d69=_0x5ce044[_0x5d0c2b(0x77)];_0xb1948e=[Permission[_0x5d0c2b(0x91)](Role['user'](_0xca3d69)),Permission[_0x5d0c2b(0x8a)](Role[_0x5d0c2b(0x8c)](_0xca3d69)),Permission[_0x5d0c2b(0x6a)](Role[_0x5d0c2b(0x8c)](_0xca3d69))];}return _0xb1948e;}async #uploadFiles(_0x3880ca){const _0x49ee3e=a0_0x2bf109,_0x2aba51=new Map();for(const _0x19c040 of _0x3880ca){if(_0x2aba51[_0x49ee3e(0x79)](_0x19c040[_0x49ee3e(0x7c)][_0x49ee3e(0x6f)]))continue;const _0x278b49=await this.#docPermissions(),_0x285309=await this.#storage[_0x49ee3e(0x85)](STORAGE_BUCKET_ID,ID[_0x49ee3e(0x81)](),_0x19c040[_0x49ee3e(0x7c)],_0x278b49);_0x2aba51[_0x49ee3e(0x72)](_0x19c040['file']['name'],_0x285309);}return _0x2aba51;}async #createFixes(_0x36e36c,_0x494bda,_0x42fdea){const _0x225372=a0_0x2bf109,_0x1ab465=[];for(const _0x1309a4 of _0x494bda){const _0x1935e8=_0x42fdea['get'](_0x1309a4[_0x225372(0x7c)][_0x225372(0x6f)]),_0x22d105=await this.#docPermissions(),_0x18338c=await this.#databases[_0x225372(0x82)](DATABASE_ID,FIXES_COLLECTION_ID,ID[_0x225372(0x81)](),{'submissionId':_0x36e36c,'fileName':_0x1935e8[_0x225372(0x6f)],'fileId':_0x1935e8['$id'],'lineNumber':_0x1309a4['lineNumber'],'deduction':_0x1309a4[_0x225372(0x7d)],'eligiblePoints':_0x1309a4[_0x225372(0x6b)]},_0x22d105);_0x1ab465['push'](_0x18338c);}return _0x1ab465;}async #getFixes(_0x1385d5){const _0x27983c=a0_0x2bf109;return this.#databases['listDocuments'](DATABASE_ID,FIXES_COLLECTION_ID,[Query[_0x27983c(0x78)]('submissionId',_0x1385d5)]);}async #deleteSubmissionGroup(_0x4badfd){const _0x450c3c=a0_0x2bf109,_0x54da62=await this.#getFixes(_0x4badfd);for(const _0x433bd2 of _0x54da62[_0x450c3c(0x6d)]){await this.#storage['deleteFile'](STORAGE_BUCKET_ID,_0x433bd2[_0x450c3c(0x7b)])['catch'](()=>{});}for(const _0x536333 of _0x54da62[_0x450c3c(0x6d)]){await this.#databases['deleteDocument'](DATABASE_ID,FIXES_COLLECTION_ID,_0x536333[_0x450c3c(0x77)])[_0x450c3c(0x74)](()=>{});}await this.#databases[_0x450c3c(0x6e)](DATABASE_ID,SUBMISSIONS_COLLECTION_ID,_0x4badfd)[_0x450c3c(0x74)](()=>{});}#computeSummary(_0x12a756){const _0x4a2c98=a0_0x2bf109;return{'fixCount':_0x12a756['length'],'totalEligible':_0x12a756[_0x4a2c98(0x71)]((_0x5dde93,_0x43a46a)=>_0x5dde93+_0x43a46a['eligiblePoints'],0x0),'totalDeductions':_0x12a756[_0x4a2c98(0x71)]((_0x1a85c4,_0x39b0e6)=>_0x1a85c4+_0x39b0e6[_0x4a2c98(0x7d)],0x0)};}}export const db=new SubmissionService(client);