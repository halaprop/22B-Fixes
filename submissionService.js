const a0_0x384d23=a0_0xd318;function a0_0xd318(_0x335be4,_0x1713ca){const _0x2e89ff=a0_0x2e89();return a0_0xd318=function(_0xd318e5,_0x4b13ec){_0xd318e5=_0xd318e5-0x15c;let _0x41fe12=_0x2e89ff[_0xd318e5];return _0x41fe12;},a0_0xd318(_0x335be4,_0x1713ca);}(function(_0x18d854,_0x49c0d7){const _0x3f89f0=a0_0xd318,_0x1713de=_0x18d854();while(!![]){try{const _0x458696=-parseInt(_0x3f89f0(0x164))/0x1+-parseInt(_0x3f89f0(0x167))/0x2*(-parseInt(_0x3f89f0(0x15e))/0x3)+-parseInt(_0x3f89f0(0x169))/0x4+parseInt(_0x3f89f0(0x16b))/0x5+parseInt(_0x3f89f0(0x17f))/0x6*(parseInt(_0x3f89f0(0x16e))/0x7)+parseInt(_0x3f89f0(0x17b))/0x8+-parseInt(_0x3f89f0(0x174))/0x9*(parseInt(_0x3f89f0(0x16a))/0xa);if(_0x458696===_0x49c0d7)break;else _0x1713de['push'](_0x1713de['shift']());}catch(_0x157b4c){_0x1713de['push'](_0x1713de['shift']());}}}(a0_0x2e89,0x46a13));import{auth}from'./auth.js';import{client,Databases,Storage,ID,Permission,Role,Query}from'./appwrite.js';const DATABASE_ID=a0_0x384d23(0x180),SUBMISSIONS_COLLECTION_ID=a0_0x384d23(0x16f),FIXES_COLLECTION_ID='fixes',ZYBOOK_STUDENTS_COLLECTION_ID='zybookStudents',STORAGE_BUCKET_ID=a0_0x384d23(0x176);class SubmissionService{#databases;#storage;constructor(_0x74a00){this.#databases=new Databases(_0x74a00),this.#storage=new Storage(_0x74a00);}async['createSubmission'](_0x391650,_0x456eb0){const _0x420015=a0_0x384d23,_0x5d3bd5=this.#submissionId(_0x391650);await this.#deleteSubmissionGroup(_0x5d3bd5);const _0x54627d=await this.#uploadFiles(_0x456eb0),_0x2747a3=await this.#createFixes(_0x5d3bd5,_0x456eb0,_0x54627d),_0xe09e3a=this.#computeSummary(_0x2747a3),_0x37e58a=await this.#docPermissions();return await this.#databases[_0x420015(0x16c)](DATABASE_ID,SUBMISSIONS_COLLECTION_ID,_0x5d3bd5,{..._0x391650,..._0xe09e3a},_0x37e58a),_0x5d3bd5;}async[a0_0x384d23(0x181)](_0x4759d5){const _0x3f1196=a0_0x384d23,_0x50656c=await this.#databases[_0x3f1196(0x17d)](DATABASE_ID,SUBMISSIONS_COLLECTION_ID,_0x4759d5),_0x4331bb=await this.#getFixes(_0x4759d5);return{'submission':_0x50656c,'fixes':_0x4331bb};}async['deleteSubmission'](_0x93b354){await this.#deleteSubmissionGroup(_0x93b354);}async['updateSubmissionGraded'](_0x13f4e3,_0x3d3df8){const _0x517be2=a0_0x384d23;return this.#databases[_0x517be2(0x15c)](DATABASE_ID,SUBMISSIONS_COLLECTION_ID,_0x13f4e3,{'graded':_0x3d3df8});}async['listSubmissions'](){const _0x30bfef=a0_0x384d23,_0x3144a0=await this.#databases[_0x30bfef(0x171)](DATABASE_ID,SUBMISSIONS_COLLECTION_ID),_0x541d6d=[];for(const _0x9c212 of _0x3144a0['documents']){const _0x375603=await this.#getFixes(_0x9c212[_0x30bfef(0x179)]);_0x541d6d[_0x30bfef(0x170)]({..._0x9c212,'fixes':_0x375603[_0x30bfef(0x173)]});}return _0x541d6d;}async['zybookStudent'](_0x4678d4){const _0x5e50d3=a0_0x384d23,_0x3af6d0=await this.#databases[_0x5e50d3(0x171)](DATABASE_ID,ZYBOOK_STUDENTS_COLLECTION_ID,[Query[_0x5e50d3(0x178)](_0x5e50d3(0x161),_0x4678d4)]);return _0x3af6d0['documents'][0x0]??null;}#submissionId({studentID:_0x3c0197,projectNumber:_0x55ca85}){return _0x3c0197+'-'+_0x55ca85;}async #docPermissions(){const _0x201915=a0_0x384d23;let _0xe8b37a=[];const _0x30dfe3=await auth[_0x201915(0x172)]();if(_0x30dfe3){const _0x43916f=_0x30dfe3[_0x201915(0x179)];_0xe8b37a=[Permission['read'](Role[_0x201915(0x17e)](_0x43916f)),Permission[_0x201915(0x15f)](Role[_0x201915(0x17e)](_0x43916f)),Permission[_0x201915(0x165)](Role[_0x201915(0x17e)](_0x43916f))];}return _0xe8b37a;}async #uploadFiles(_0x1c003c){const _0x3cba4c=a0_0x384d23,_0x367339=new Map();for(const _0xe0b03f of _0x1c003c){if(_0x367339['has'](_0xe0b03f['file']['name']))continue;const _0x1c2dde=await this.#docPermissions(),_0x51fb44=await this.#storage[_0x3cba4c(0x162)](STORAGE_BUCKET_ID,ID['unique'](),_0xe0b03f['file'],_0x1c2dde);_0x367339[_0x3cba4c(0x160)](_0xe0b03f[_0x3cba4c(0x182)][_0x3cba4c(0x163)],_0x51fb44);}return _0x367339;}async #createFixes(_0x539206,_0x4e909b,_0x528e72){const _0x4b6ec3=a0_0x384d23,_0x59a494=[];for(const _0x16030a of _0x4e909b){const _0x53a048=_0x528e72[_0x4b6ec3(0x17c)](_0x16030a[_0x4b6ec3(0x182)][_0x4b6ec3(0x163)]),_0x254015=await this.#docPermissions(),_0xc78a44=await this.#databases[_0x4b6ec3(0x16c)](DATABASE_ID,FIXES_COLLECTION_ID,ID['unique'](),{'submissionId':_0x539206,'fileName':_0x53a048[_0x4b6ec3(0x163)],'fileId':_0x53a048[_0x4b6ec3(0x179)],'lineNumber':_0x16030a[_0x4b6ec3(0x15d)],'deduction':_0x16030a[_0x4b6ec3(0x16d)],'eligiblePoints':_0x16030a[_0x4b6ec3(0x177)]},_0x254015);_0x59a494[_0x4b6ec3(0x170)](_0xc78a44);}return _0x59a494;}async #getFixes(_0x2723ed){const _0x3b79fa=a0_0x384d23;return this.#databases[_0x3b79fa(0x171)](DATABASE_ID,FIXES_COLLECTION_ID,[Query[_0x3b79fa(0x178)]('submissionId',_0x2723ed)]);}async #deleteSubmissionGroup(_0x2339c5){const _0x242cd0=a0_0x384d23,_0x1d0b15=await this.#getFixes(_0x2339c5);for(const _0x600e0e of _0x1d0b15[_0x242cd0(0x173)]){await this.#storage[_0x242cd0(0x175)](STORAGE_BUCKET_ID,_0x600e0e[_0x242cd0(0x168)])[_0x242cd0(0x166)](()=>{});}for(const _0x35254f of _0x1d0b15[_0x242cd0(0x173)]){await this.#databases[_0x242cd0(0x17a)](DATABASE_ID,FIXES_COLLECTION_ID,_0x35254f[_0x242cd0(0x179)])['catch'](()=>{});}await this.#databases[_0x242cd0(0x17a)](DATABASE_ID,SUBMISSIONS_COLLECTION_ID,_0x2339c5)['catch'](()=>{});}#computeSummary(_0x1c8e5d){const _0x52c9bd=a0_0x384d23;return{'fixCount':_0x1c8e5d['length'],'totalEligible':_0x1c8e5d[_0x52c9bd(0x183)]((_0x46d5f5,_0x140f0d)=>_0x46d5f5+_0x140f0d[_0x52c9bd(0x177)],0x0),'totalDeductions':_0x1c8e5d['reduce']((_0x44b619,_0x27ad93)=>_0x44b619+_0x27ad93[_0x52c9bd(0x16d)],0x0)};}}function a0_0x2e89(){const _0x35b541=['push','listDocuments','getUser','documents','144LksdXt','deleteFile','6945a9930023af1a7139','eligiblePoints','equal','$id','deleteDocument','4158080fXtmSt','get','getDocument','user','231414zHTFWe','6945a6580034b3c579df','readSubmission','file','reduce','updateDocument','lineNumber','3xdIXmB','update','set','canvasId','createFile','name','319764QJWgyG','delete','catch','797398otYhib','fileId','1002044GOawgi','382000sIDfKl','1411660nrIakq','createDocument','deduction','49HWSNiG','submissions'];a0_0x2e89=function(){return _0x35b541;};return a0_0x2e89();}export const db=new SubmissionService(client);