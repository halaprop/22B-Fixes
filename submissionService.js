const a0_0x2163e1=a0_0x3a28;(function(_0x41e8a0,_0x34812a){const _0x48cac4=a0_0x3a28,_0x4a28a6=_0x41e8a0();while(!![]){try{const _0x1f451c=parseInt(_0x48cac4(0x192))/0x1*(parseInt(_0x48cac4(0x171))/0x2)+-parseInt(_0x48cac4(0x196))/0x3*(parseInt(_0x48cac4(0x16f))/0x4)+-parseInt(_0x48cac4(0x172))/0x5*(parseInt(_0x48cac4(0x187))/0x6)+parseInt(_0x48cac4(0x18a))/0x7+-parseInt(_0x48cac4(0x17d))/0x8+parseInt(_0x48cac4(0x197))/0x9*(-parseInt(_0x48cac4(0x18c))/0xa)+parseInt(_0x48cac4(0x174))/0xb;if(_0x1f451c===_0x34812a)break;else _0x4a28a6['push'](_0x4a28a6['shift']());}catch(_0x445543){_0x4a28a6['push'](_0x4a28a6['shift']());}}}(a0_0x5483,0x580d6));import{auth}from'./auth.js';import{client,Databases,Storage,ID,Permission,Role,Query}from'./appwrite.js';const DATABASE_ID=a0_0x2163e1(0x181),SUBMISSIONS_COLLECTION_ID=a0_0x2163e1(0x184),FIXES_COLLECTION_ID=a0_0x2163e1(0x177),ZYBOOK_STUDENTS_COLLECTION_ID=a0_0x2163e1(0x17f),STORAGE_BUCKET_ID=a0_0x2163e1(0x16d);function a0_0x5483(){const _0xec8cb=['6945a6580034b3c579df','eligiblePoints','createFile','submissions','documents','deleteDocument','3042462MtRcfc','deleteFile','deduction','64246mPijse','submissionId','1063110liVIdH','getUser','name','equal','file','catch','562OWPzNb','updateDocument','createDocument','length','1857YrzqFn','45TGWbfa','zybookStudent','reduce','6945a9930023af1a7139','get','2984RIFAiG','getDocument','2510wMHAKL','5MsdogG','user','19911386FSBCGZ','listDocuments','$id','fixes','has','push','lineNumber','fileId','deleteSubmission','5308368QZqsTd','unique','zybookStudents','listSubmissions'];a0_0x5483=function(){return _0xec8cb;};return a0_0x5483();}function a0_0x3a28(_0x73466e,_0x125bc0){const _0x548352=a0_0x5483();return a0_0x3a28=function(_0x3a2899,_0x587665){_0x3a2899=_0x3a2899-0x16d;let _0x338cc7=_0x548352[_0x3a2899];return _0x338cc7;},a0_0x3a28(_0x73466e,_0x125bc0);}class SubmissionService{#databases;#storage;constructor(_0x35a15b){this.#databases=new Databases(_0x35a15b),this.#storage=new Storage(_0x35a15b);}async['createSubmission'](_0x461c53,_0x31403f){const _0x23e5bf=this.#submissionId(_0x461c53);await this.#deleteSubmissionGroup(_0x23e5bf);const _0x4f84bb=await this.#uploadFiles(_0x31403f),_0x24ff6b=await this.#createFixes(_0x23e5bf,_0x31403f,_0x4f84bb),_0x7e5ae1=this.#computeSummary(_0x24ff6b),_0x7680f7=await this.#docPermissions();return await this.#databases['createDocument'](DATABASE_ID,SUBMISSIONS_COLLECTION_ID,_0x23e5bf,{..._0x461c53,..._0x7e5ae1},_0x7680f7),_0x23e5bf;}async['readSubmission'](_0x205573){const _0x3fa6fd=a0_0x2163e1,_0x229346=await this.#databases[_0x3fa6fd(0x170)](DATABASE_ID,SUBMISSIONS_COLLECTION_ID,_0x205573),_0x4921e9=await this.#getFixes(_0x205573);return{'submission':_0x229346,'fixes':_0x4921e9};}async[a0_0x2163e1(0x17c)](_0x41c06b){await this.#deleteSubmissionGroup(_0x41c06b);}async['updateSubmissionGraded'](_0x4ed9b5,_0x5300a6){const _0x5f5041=a0_0x2163e1;return this.#databases[_0x5f5041(0x193)](DATABASE_ID,SUBMISSIONS_COLLECTION_ID,_0x4ed9b5,{'graded':_0x5300a6});}async[a0_0x2163e1(0x180)](){const _0x8793d1=a0_0x2163e1,_0x165b9c=await this.#databases['listDocuments'](DATABASE_ID,SUBMISSIONS_COLLECTION_ID),_0x2f7c18=[];for(const _0x4692ef of _0x165b9c[_0x8793d1(0x185)]){const _0x438623=await this.#getFixes(_0x4692ef[_0x8793d1(0x176)]);_0x2f7c18[_0x8793d1(0x179)]({..._0x4692ef,'fixes':_0x438623[_0x8793d1(0x185)]});}return _0x2f7c18;}async[a0_0x2163e1(0x198)](_0x19e432){const _0x5505c8=a0_0x2163e1,_0x4ffe91=await this.#databases[_0x5505c8(0x175)](DATABASE_ID,ZYBOOK_STUDENTS_COLLECTION_ID,[Query[_0x5505c8(0x18f)]('canvasId',_0x19e432)]);return _0x4ffe91[_0x5505c8(0x185)][0x0]??null;}#submissionId({studentID:_0x39d531,projectNumber:_0x3c35c8}){return _0x39d531+'-'+_0x3c35c8;}async #docPermissions(){const _0x1b5384=a0_0x2163e1;let _0x1adbff=[];const _0x48dac9=await auth[_0x1b5384(0x18d)]();if(_0x48dac9){const _0x560eab=_0x48dac9['$id'];_0x1adbff=[Permission['read'](Role[_0x1b5384(0x173)](_0x560eab)),Permission['update'](Role[_0x1b5384(0x173)](_0x560eab)),Permission['delete'](Role[_0x1b5384(0x173)](_0x560eab))];}return _0x1adbff;}async #uploadFiles(_0x7d84d5){const _0x58d2a7=a0_0x2163e1,_0x8d091=new Map();for(const _0x405da4 of _0x7d84d5){if(_0x8d091[_0x58d2a7(0x178)](_0x405da4[_0x58d2a7(0x190)][_0x58d2a7(0x18e)]))continue;const _0x20fe1a=await this.#docPermissions(),_0x2b101a=await this.#storage[_0x58d2a7(0x183)](STORAGE_BUCKET_ID,ID['unique'](),_0x405da4[_0x58d2a7(0x190)],_0x20fe1a);_0x8d091['set'](_0x405da4['file'][_0x58d2a7(0x18e)],_0x2b101a);}return _0x8d091;}async #createFixes(_0x321155,_0x221d68,_0x25503b){const _0x13c1ee=a0_0x2163e1,_0x3abb9d=[];for(const _0xf8a85f of _0x221d68){const _0x4bea6b=_0x25503b[_0x13c1ee(0x16e)](_0xf8a85f[_0x13c1ee(0x190)][_0x13c1ee(0x18e)]),_0x1f1d8c=await this.#docPermissions(),_0x42cedb=await this.#databases[_0x13c1ee(0x194)](DATABASE_ID,FIXES_COLLECTION_ID,ID[_0x13c1ee(0x17e)](),{'submissionId':_0x321155,'fileName':_0x4bea6b['name'],'fileId':_0x4bea6b[_0x13c1ee(0x176)],'lineNumber':_0xf8a85f[_0x13c1ee(0x17a)],'deduction':_0xf8a85f[_0x13c1ee(0x189)],'eligiblePoints':_0xf8a85f[_0x13c1ee(0x182)]},_0x1f1d8c);_0x3abb9d[_0x13c1ee(0x179)](_0x42cedb);}return _0x3abb9d;}async #getFixes(_0x1bf528){const _0x55d0cf=a0_0x2163e1;return this.#databases[_0x55d0cf(0x175)](DATABASE_ID,FIXES_COLLECTION_ID,[Query[_0x55d0cf(0x18f)](_0x55d0cf(0x18b),_0x1bf528)]);}async #deleteSubmissionGroup(_0x52ba2d){const _0x1febc0=a0_0x2163e1,_0x332ef4=await this.#getFixes(_0x52ba2d);for(const _0x11dfea of _0x332ef4['documents']){await this.#storage[_0x1febc0(0x188)](STORAGE_BUCKET_ID,_0x11dfea[_0x1febc0(0x17b)])[_0x1febc0(0x191)](()=>{});}for(const _0x4de147 of _0x332ef4[_0x1febc0(0x185)]){await this.#databases[_0x1febc0(0x186)](DATABASE_ID,FIXES_COLLECTION_ID,_0x4de147['$id'])[_0x1febc0(0x191)](()=>{});}await this.#databases[_0x1febc0(0x186)](DATABASE_ID,SUBMISSIONS_COLLECTION_ID,_0x52ba2d)[_0x1febc0(0x191)](()=>{});}#computeSummary(_0x1d765a){const _0x1ba491=a0_0x2163e1;return{'fixCount':_0x1d765a[_0x1ba491(0x195)],'totalEligible':_0x1d765a[_0x1ba491(0x199)]((_0x2f2b48,_0x48f3e1)=>_0x2f2b48+_0x48f3e1['eligiblePoints'],0x0),'totalDeductions':_0x1d765a[_0x1ba491(0x199)]((_0x23ab6a,_0x500e4b)=>_0x23ab6a+_0x500e4b[_0x1ba491(0x189)],0x0)};}}export const db=new SubmissionService(client);