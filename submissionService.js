function a0_0x2b35(){const _0x211c54=['eligiblePoints','updateSubmissionGraded','file','equal','reduce','readSubmission','read','$id','name','getDocument','listDocuments','get','submissionId','createSubmission','3907460KwAkGN','846981BQCYvk','user','push','deduction','update','length','deleteFile','6945a9930023af1a7139','documents','canvasId','submissions','6945a6580034b3c579df','deleteDocument','getUser','11653648VoquZB','16234IvfRnR','createDocument','lineNumber','listSubmissions','229100MnUALI','unique','7GLIMjk','fixes','updateDocument','fileId','catch','26988606jEZICT','89uRkced','6167820fUaNcn','createFile','delete'];a0_0x2b35=function(){return _0x211c54;};return a0_0x2b35();}const a0_0x5376fb=a0_0x5b82;(function(_0x4d737a,_0x58595e){const _0x12c8ae=a0_0x5b82,_0x597c39=_0x4d737a();while(!![]){try{const _0x1ef94c=-parseInt(_0x12c8ae(0x127))/0x1*(-parseInt(_0x12c8ae(0x11b))/0x2)+-parseInt(_0x12c8ae(0x13a))/0x3+parseInt(_0x12c8ae(0x139))/0x4+-parseInt(_0x12c8ae(0x11f))/0x5+-parseInt(_0x12c8ae(0x128))/0x6*(-parseInt(_0x12c8ae(0x121))/0x7)+parseInt(_0x12c8ae(0x11a))/0x8+-parseInt(_0x12c8ae(0x126))/0x9;if(_0x1ef94c===_0x58595e)break;else _0x597c39['push'](_0x597c39['shift']());}catch(_0x3ee2c9){_0x597c39['push'](_0x597c39['shift']());}}}(a0_0x2b35,0xd13f1));import{auth}from'./auth.js';import{client,Databases,Storage,ID,Permission,Role,Query}from'./appwrite.js';const DATABASE_ID=a0_0x5376fb(0x145),SUBMISSIONS_COLLECTION_ID=a0_0x5376fb(0x144),FIXES_COLLECTION_ID=a0_0x5376fb(0x122),ZYBOOK_STUDENTS_COLLECTION_ID='zybookStudents',STORAGE_BUCKET_ID=a0_0x5376fb(0x141);class SubmissionService{#databases;#storage;constructor(_0x127546){this.#databases=new Databases(_0x127546),this.#storage=new Storage(_0x127546);}async[a0_0x5376fb(0x138)](_0x1e74af,_0x216644){const _0xf7389e=this.#submissionId(_0x1e74af);await this.#deleteSubmissionGroup(_0xf7389e);const _0x3285f1=await this.#uploadFiles(_0x216644),_0x58294a=await this.#createFixes(_0xf7389e,_0x216644,_0x3285f1),_0x393cc0=this.#computeSummary(_0x58294a),_0x4ff1ab=await this.#docPermissions();return await this.#databases['createDocument'](DATABASE_ID,SUBMISSIONS_COLLECTION_ID,_0xf7389e,{..._0x1e74af,..._0x393cc0},_0x4ff1ab),_0xf7389e;}async[a0_0x5376fb(0x130)](_0x4592ae){const _0x191f93=a0_0x5376fb,_0x84a5d0=await this.#databases[_0x191f93(0x134)](DATABASE_ID,SUBMISSIONS_COLLECTION_ID,_0x4592ae),_0x1c9ff6=await this.#getFixes(_0x4592ae);return{'submission':_0x84a5d0,'fixes':_0x1c9ff6};}async['deleteSubmission'](_0x947cbc){await this.#deleteSubmissionGroup(_0x947cbc);}async[a0_0x5376fb(0x12c)](_0x81432b,_0x3fe138){const _0x39bb1a=a0_0x5376fb;return this.#databases[_0x39bb1a(0x123)](DATABASE_ID,SUBMISSIONS_COLLECTION_ID,_0x81432b,{'graded':_0x3fe138});}async[a0_0x5376fb(0x11e)](){const _0x2371bb=a0_0x5376fb,_0x58ecbc=await this.#databases['listDocuments'](DATABASE_ID,SUBMISSIONS_COLLECTION_ID),_0x5ca94c=[];for(const _0x25916a of _0x58ecbc[_0x2371bb(0x142)]){const _0x1f64c8=await this.#getFixes(_0x25916a[_0x2371bb(0x132)]);_0x5ca94c[_0x2371bb(0x13c)]({..._0x25916a,'fixes':_0x1f64c8[_0x2371bb(0x142)]});}return _0x5ca94c;}async['zybookStudent'](_0x3ca79f){const _0x47e109=a0_0x5376fb,_0x4750d9=await this.#databases[_0x47e109(0x135)](DATABASE_ID,ZYBOOK_STUDENTS_COLLECTION_ID,[Query[_0x47e109(0x12e)](_0x47e109(0x143),_0x3ca79f)]);return _0x4750d9[_0x47e109(0x142)][0x0]??null;}#submissionId({studentID:_0xaff049,projectNumber:_0x16ca88}){return _0xaff049+'-'+_0x16ca88;}async #docPermissions(){const _0x328a26=a0_0x5376fb;let _0x2ca4bf=[];const _0x1d61ab=await auth[_0x328a26(0x119)]();if(_0x1d61ab){const _0x51a4ce=_0x1d61ab[_0x328a26(0x132)];_0x2ca4bf=[Permission[_0x328a26(0x131)](Role[_0x328a26(0x13b)](_0x51a4ce)),Permission[_0x328a26(0x13e)](Role[_0x328a26(0x13b)](_0x51a4ce)),Permission[_0x328a26(0x12a)](Role[_0x328a26(0x13b)](_0x51a4ce))];}return _0x2ca4bf;}async #uploadFiles(_0x4e46ed){const _0x515538=a0_0x5376fb,_0x35a1fa=new Map();for(const _0x4dabc7 of _0x4e46ed){if(_0x35a1fa['has'](_0x4dabc7[_0x515538(0x12d)]['name']))continue;const _0x116a95=await this.#docPermissions(),_0x417f60=await this.#storage[_0x515538(0x129)](STORAGE_BUCKET_ID,ID['unique'](),_0x4dabc7['file'],_0x116a95);_0x35a1fa['set'](_0x4dabc7[_0x515538(0x12d)][_0x515538(0x133)],_0x417f60);}return _0x35a1fa;}async #createFixes(_0x26a6f4,_0xdeaed1,_0x5b37f5){const _0x5591ee=a0_0x5376fb,_0x183924=[];for(const _0x4dee1b of _0xdeaed1){const _0x2a0710=_0x5b37f5[_0x5591ee(0x136)](_0x4dee1b[_0x5591ee(0x12d)][_0x5591ee(0x133)]),_0x115db8=await this.#docPermissions(),_0x43868d=await this.#databases[_0x5591ee(0x11c)](DATABASE_ID,FIXES_COLLECTION_ID,ID[_0x5591ee(0x120)](),{'submissionId':_0x26a6f4,'fileName':_0x2a0710['name'],'fileId':_0x2a0710['$id'],'lineNumber':_0x4dee1b[_0x5591ee(0x11d)],'deduction':_0x4dee1b[_0x5591ee(0x13d)],'eligiblePoints':_0x4dee1b[_0x5591ee(0x12b)]},_0x115db8);_0x183924['push'](_0x43868d);}return _0x183924;}async #getFixes(_0x57f83a){const _0x41bdff=a0_0x5376fb;return this.#databases['listDocuments'](DATABASE_ID,FIXES_COLLECTION_ID,[Query[_0x41bdff(0x12e)](_0x41bdff(0x137),_0x57f83a)]);}async #deleteSubmissionGroup(_0x184620){const _0x14d85e=a0_0x5376fb,_0x427b99=await this.#getFixes(_0x184620);for(const _0x419516 of _0x427b99[_0x14d85e(0x142)]){await this.#storage[_0x14d85e(0x140)](STORAGE_BUCKET_ID,_0x419516[_0x14d85e(0x124)])[_0x14d85e(0x125)](()=>{});}for(const _0x4b3c6a of _0x427b99[_0x14d85e(0x142)]){await this.#databases[_0x14d85e(0x146)](DATABASE_ID,FIXES_COLLECTION_ID,_0x4b3c6a['$id'])[_0x14d85e(0x125)](()=>{});}await this.#databases[_0x14d85e(0x146)](DATABASE_ID,SUBMISSIONS_COLLECTION_ID,_0x184620)['catch'](()=>{});}#computeSummary(_0x233e51){const _0x393570=a0_0x5376fb;return{'fixCount':_0x233e51[_0x393570(0x13f)],'totalEligible':_0x233e51[_0x393570(0x12f)]((_0x277e09,_0x48694e)=>_0x277e09+_0x48694e[_0x393570(0x12b)],0x0),'totalDeductions':_0x233e51[_0x393570(0x12f)]((_0x1cf098,_0xf027a)=>_0x1cf098+_0xf027a[_0x393570(0x13d)],0x0)};}}function a0_0x5b82(_0x18599c,_0x440b86){const _0x2b351b=a0_0x2b35();return a0_0x5b82=function(_0x5b82e8,_0x1cbdaa){_0x5b82e8=_0x5b82e8-0x119;let _0x5a4b54=_0x2b351b[_0x5b82e8];return _0x5a4b54;},a0_0x5b82(_0x18599c,_0x440b86);}export const db=new SubmissionService(client);