function a0_0x30b2(){const _0x1b7be0=['2570FfsWRh','31322nDpzyv','name','updateSubmissionGraded','zybookStudent','equal','delete','canvasId','fileId','735682ydjyke','6100296CArftS','getUser','reduce','141GHhzWi','file','listDocuments','deleteDocument','createFile','512806oFqgMC','deduction','unique','getDocument','6945a6580034b3c579df','zybookStudents','set','user','21006mpoSPU','$id','4780344XWbqCK','listSubmissions','6945a9930023af1a7139','push','createDocument','read','get','documents','updateDocument','5zvAmCx','6515088ZjNNTc','has','catch','deleteSubmission','eligiblePoints','deleteFile'];a0_0x30b2=function(){return _0x1b7be0;};return a0_0x30b2();}const a0_0x193080=a0_0x5880;(function(_0x1588c6,_0x5d4f41){const _0x233990=a0_0x5880,_0x4372d0=_0x1588c6();while(!![]){try{const _0x2d3de1=parseInt(_0x233990(0x1a9))/0x1+parseInt(_0x233990(0x1a1))/0x2*(parseInt(_0x233990(0x1ad))/0x3)+-parseInt(_0x233990(0x1bc))/0x4+-parseInt(_0x233990(0x199))/0x5*(parseInt(_0x233990(0x19a))/0x6)+parseInt(_0x233990(0x1b2))/0x7+parseInt(_0x233990(0x1aa))/0x8+-parseInt(_0x233990(0x1ba))/0x9*(-parseInt(_0x233990(0x1a0))/0xa);if(_0x2d3de1===_0x5d4f41)break;else _0x4372d0['push'](_0x4372d0['shift']());}catch(_0x2f3081){_0x4372d0['push'](_0x4372d0['shift']());}}}(a0_0x30b2,0x98f10));import{auth}from'./auth.js';import{client,Databases,Storage,ID,Permission,Role,Query}from'./appwrite.js';const DATABASE_ID=a0_0x193080(0x1b6),SUBMISSIONS_COLLECTION_ID='submissions',FIXES_COLLECTION_ID='fixes',ZYBOOK_STUDENTS_COLLECTION_ID=a0_0x193080(0x1b7),STORAGE_BUCKET_ID=a0_0x193080(0x1be);function a0_0x5880(_0x5bf92e,_0x3613f8){const _0x30b20e=a0_0x30b2();return a0_0x5880=function(_0x5880a8,_0xe2525f){_0x5880a8=_0x5880a8-0x196;let _0x44db6e=_0x30b20e[_0x5880a8];return _0x44db6e;},a0_0x5880(_0x5bf92e,_0x3613f8);}class SubmissionService{#databases;#storage;constructor(_0x2d2cef){this.#databases=new Databases(_0x2d2cef),this.#storage=new Storage(_0x2d2cef);}async['createSubmission'](_0xaffdf9,_0x34bfe8){const _0x596be8=a0_0x193080,_0x490e19=this.#submissionId(_0xaffdf9);await this.#deleteSubmissionGroup(_0x490e19);const _0x37393a=await this.#uploadFiles(_0x34bfe8),_0x5ee628=await this.#createFixes(_0x490e19,_0x34bfe8,_0x37393a),_0x26964d=this.#computeSummary(_0x5ee628),_0x576b93=await this.#docPermissions();return await this.#databases[_0x596be8(0x1c0)](DATABASE_ID,SUBMISSIONS_COLLECTION_ID,_0x490e19,{..._0xaffdf9,..._0x26964d},_0x576b93),_0x490e19;}async['readSubmission'](_0x2a9352){const _0x3edfce=a0_0x193080,_0x1a8fcf=await this.#databases[_0x3edfce(0x1b5)](DATABASE_ID,SUBMISSIONS_COLLECTION_ID,_0x2a9352),_0x1e64b4=await this.#getFixes(_0x2a9352);return{'submission':_0x1a8fcf,'fixes':_0x1e64b4};}async[a0_0x193080(0x19d)](_0x439bb2){await this.#deleteSubmissionGroup(_0x439bb2);}async[a0_0x193080(0x1a3)](_0x59dda8,_0x4ee00b){const _0x1fcc44=a0_0x193080;return this.#databases[_0x1fcc44(0x198)](DATABASE_ID,SUBMISSIONS_COLLECTION_ID,_0x59dda8,{'graded':_0x4ee00b});}async[a0_0x193080(0x1bd)](){const _0x58a377=a0_0x193080,_0x533e27=await this.#databases[_0x58a377(0x1af)](DATABASE_ID,SUBMISSIONS_COLLECTION_ID),_0x56f969=[];for(const _0x3730ac of _0x533e27[_0x58a377(0x197)]){const _0x3fa935=await this.#getFixes(_0x3730ac['$id']);_0x56f969['push']({..._0x3730ac,'fixes':_0x3fa935['documents']});}return _0x56f969;}async[a0_0x193080(0x1a4)](_0x5c08dd){const _0x5de7aa=a0_0x193080,_0x26f3cc=await this.#databases['listDocuments'](DATABASE_ID,ZYBOOK_STUDENTS_COLLECTION_ID,[Query['equal'](_0x5de7aa(0x1a7),_0x5c08dd)]);return _0x26f3cc[_0x5de7aa(0x197)][0x0]??null;}#submissionId({studentID:_0x74562f,projectNumber:_0x2eea1d}){return _0x74562f+'-'+_0x2eea1d;}async #docPermissions(){const _0x27c4bf=a0_0x193080;let _0x401df5=[];const _0x9ebf19=await auth[_0x27c4bf(0x1ab)]();if(_0x9ebf19){const _0x423575=_0x9ebf19[_0x27c4bf(0x1bb)];_0x401df5=[Permission[_0x27c4bf(0x1c1)](Role[_0x27c4bf(0x1b9)](_0x423575)),Permission['update'](Role[_0x27c4bf(0x1b9)](_0x423575)),Permission[_0x27c4bf(0x1a6)](Role[_0x27c4bf(0x1b9)](_0x423575))];}return _0x401df5;}async #uploadFiles(_0x3160b6){const _0x3dbd75=a0_0x193080,_0x37bb75=new Map();for(const _0x1c9526 of _0x3160b6){if(_0x37bb75[_0x3dbd75(0x19b)](_0x1c9526[_0x3dbd75(0x1ae)][_0x3dbd75(0x1a2)]))continue;const _0x159576=await this.#docPermissions(),_0x3954ce=await this.#storage[_0x3dbd75(0x1b1)](STORAGE_BUCKET_ID,ID[_0x3dbd75(0x1b4)](),_0x1c9526[_0x3dbd75(0x1ae)],_0x159576);_0x37bb75[_0x3dbd75(0x1b8)](_0x1c9526['file'][_0x3dbd75(0x1a2)],_0x3954ce);}return _0x37bb75;}async #createFixes(_0x29b3cf,_0x2696a6,_0x161087){const _0x84a7a5=a0_0x193080,_0xa1a29b=[];for(const _0x2cf5a1 of _0x2696a6){const _0x10d876=_0x161087[_0x84a7a5(0x196)](_0x2cf5a1[_0x84a7a5(0x1ae)]['name']),_0x228433=await this.#docPermissions(),_0x2b7bd6=await this.#databases[_0x84a7a5(0x1c0)](DATABASE_ID,FIXES_COLLECTION_ID,ID[_0x84a7a5(0x1b4)](),{'submissionId':_0x29b3cf,'fileName':_0x10d876[_0x84a7a5(0x1a2)],'fileId':_0x10d876[_0x84a7a5(0x1bb)],'lineNumber':_0x2cf5a1['lineNumber'],'deduction':_0x2cf5a1[_0x84a7a5(0x1b3)],'eligiblePoints':_0x2cf5a1['eligiblePoints']},_0x228433);_0xa1a29b[_0x84a7a5(0x1bf)](_0x2b7bd6);}return _0xa1a29b;}async #getFixes(_0x48cf96){const _0xe171a5=a0_0x193080;return this.#databases['listDocuments'](DATABASE_ID,FIXES_COLLECTION_ID,[Query[_0xe171a5(0x1a5)]('submissionId',_0x48cf96)]);}async #deleteSubmissionGroup(_0x4cda07){const _0x54fb23=a0_0x193080,_0x55298f=await this.#getFixes(_0x4cda07);for(const _0x2065a9 of _0x55298f[_0x54fb23(0x197)]){await this.#storage[_0x54fb23(0x19f)](STORAGE_BUCKET_ID,_0x2065a9[_0x54fb23(0x1a8)])[_0x54fb23(0x19c)](()=>{});}for(const _0x5f1172 of _0x55298f[_0x54fb23(0x197)]){await this.#databases[_0x54fb23(0x1b0)](DATABASE_ID,FIXES_COLLECTION_ID,_0x5f1172[_0x54fb23(0x1bb)])[_0x54fb23(0x19c)](()=>{});}await this.#databases[_0x54fb23(0x1b0)](DATABASE_ID,SUBMISSIONS_COLLECTION_ID,_0x4cda07)[_0x54fb23(0x19c)](()=>{});}#computeSummary(_0x5491be){const _0x6e5176=a0_0x193080;return{'fixCount':_0x5491be['length'],'totalEligible':_0x5491be[_0x6e5176(0x1ac)]((_0x466875,_0x1ed8d6)=>_0x466875+_0x1ed8d6[_0x6e5176(0x19e)],0x0),'totalDeductions':_0x5491be[_0x6e5176(0x1ac)]((_0x5d8b9f,_0x1b36d3)=>_0x5d8b9f+_0x1b36d3[_0x6e5176(0x1b3)],0x0)};}}export const db=new SubmissionService(client);